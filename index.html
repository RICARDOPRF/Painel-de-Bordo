<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo - Empresa</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; display: flex; }
        #sidebar { transition: all 0.3s; width: 60px; z-index: 1000; overflow: hidden; height: 100vh; position: fixed; left: 0; top: 0; }
        #sidebar:hover { width: 260px; }
        .menu-label { opacity: 0; transition: opacity 0.2s; white-space: nowrap; font-size: 11px; font-weight: bold; }
        #sidebar:hover .menu-label { opacity: 1; }
        .painel-container { background: white; padding: 25px; border: 1px solid #cbd5e1; width: 1150px; margin: 20px auto; min-height: 800px; }
        .tab-bor, .tab-prod { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; border: 1.5px solid #1e293b; }
        .tab-bor th, .tab-bor td, .tab-prod th, .tab-prod td { border: 1px solid #cbd5e1; padding: 6px 2px; text-align: center; }
        .tab-bor tbody tr:nth-child(even) { background-color: #f8fafc; }
        .header-azul { background-color: #1e3a8a !important; color: white !important; font-weight: bold; text-transform: uppercase; }
        .logo-box { width: 180px; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .faixa-indicadores { background-color: #1e3a8a; color: white; display: flex; justify-content: space-around; padding: 12px; border: 1px solid #172554; margin-bottom: 5px; }
        .ind-item { text-align: center; border-right: 1px solid rgba(255,255,255,0.2); flex: 1; }
        .ind-item:last-child { border-right: none; }
        .ind-label { font-size: 9px; font-weight: bold; text-transform: uppercase; display: block; opacity: 0.9; }
        .ind-value { font-size: 15px; font-weight: 800; display: block; margin-top: 2px; }
        textarea { border: 1px solid #e2e8f0 !important; padding: 8px !important; background: #ffffff !important; font-size: 11px; color: #334155; width: 100%; height: 90px; resize: none; border-radius: 4px; line-height: 1.4; }
        .btnFonte { padding: 2px 5px; font-size: 9px; border: 1px solid #cbd5e1; background: #fff; border-radius: 3px; cursor: pointer; font-weight: bold; color: #1e3a8a; }
        .btnFonte:hover { background: #f1f5f9; }
        #modalConfig { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .sub-header-data { font-size: 8px; font-weight: bold; display: block; color: rgba(255,255,255,0.8); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav id="sidebar" class="bg-slate-900 flex flex-col text-white shadow-xl">
        <div class="p-4 mb-6 border-b border-slate-700 flex items-center gap-4">
            <span class="text-xl">üìä</span><span class="menu-label uppercase">Painel Empresa</span>
        </div>
        <div class="flex flex-col gap-4 px-3">
            <button onclick="irPara('principal')" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left">
                <span>üè†</span> <span class="menu-label uppercase">Painel de Bordo</span>
            </button>
            <button onclick="irPara('produtividade')" class="p-3 hover:bg-green-800 rounded flex items-center gap-4 transition text-left">
                <span>üìà</span> <span class="menu-label uppercase">Estudo Produtividade</span>
            </button>
            <hr class="border-slate-700">
            <button onclick="document.getElementById('modalConfig').style.display='flex'" class="p-3 hover:bg-blue-800 rounded flex items-center gap-4 transition text-left">
                <span>‚öôÔ∏è</span> <span class="menu-label uppercase">Configura√ß√£o</span>
            </button>
            <button onclick="document.getElementById('fCurva').click()" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left">
                <span>üìÇ</span> <span class="menu-label uppercase">Dados Curva S</span>
            </button>
            <button onclick="document.getElementById('fHH').click()" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left">
                <span>üë∑</span> <span class="menu-label uppercase">Dados HH</span>
            </button>
        </div>
    </nav>

    <input type="file" id="fLogoEmpresa" class="hidden" accept="image/*">
    <input type="file" id="fLogoCliente" class="hidden" accept="image/*">
    <input type="file" id="fCurva" accept=".xlsx" class="hidden">
    <input type="file" id="fHH" accept=".xlsx" class="hidden">

    <main class="flex-1 ml-[60px]">
        <div id="telaPrincipal" class="painel-container">
            <div class="flex justify-between items-center mb-4">
                <div id="btnLogoEmpresa" class="logo-box cursor-pointer">
                    <img id="imgEmpresa" src="https://i.imgur.com/uGzX6Vp.png">
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-black uppercase tracking-tight text-blue-900">Painel de Bordo</h1>
                    <p id="dspClienteObra" class="text-[11px] font-bold text-slate-500 uppercase">CLIENTE | OBRA</p>
                </div>
                <div id="btnLogoCliente" class="logo-box border border-dashed border-slate-300 rounded cursor-pointer">
                    <span id="txtLogoCliente" class="text-[9px] text-slate-400 font-bold uppercase">Logo Cliente</span>
                    <img id="imgCliente" class="hidden">
                </div>
            </div>

            <div class="faixa-indicadores">
                <div class="ind-item"><span class="ind-label">Avan√ßo Realizado</span><span class="ind-value text-green-400" id="dspAvancoReal">0.00%</span></div>
                <div class="ind-item"><span class="ind-label">Produtividade Acum.</span><span class="ind-value" id="dspProdAcum">0%</span></div>
                <div class="ind-item"><span class="ind-label">HH Real Acumulado</span><span class="ind-value text-yellow-300" id="dspHHRealAcm">0,00</span></div>
                <div class="ind-item"><span class="ind-label">Tempo Decorrido</span><span class="ind-value" id="dspTempoPerc">0%</span></div>
                <div class="ind-item"><span class="ind-label">Data de Corte</span><span class="ind-value" id="dspDataDomingo">-</span></div>
                <div class="ind-item bg-blue-950 px-2 rounded">
                    <span class="ind-label text-blue-300">Semana Ref.</span>
                    <select id="selSemana" class="outline-none font-black text-[13px] w-full text-center bg-transparent text-white cursor-pointer"></select>
                </div>
            </div>

            <div class="grid grid-cols-6 gap-0 text-center mb-4 border border-slate-300 bg-slate-50">
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold text-blue-900 uppercase">In√≠cio</span><span id="stDataInicio" class="text-[12px] font-black text-blue-800">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold text-blue-900 uppercase">T√©rmino</span><span id="stDataFim" class="text-[12px] font-black text-blue-800">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold text-green-700 uppercase">Prazo Total</span><span id="stPrazo" class="text-[12px] font-black text-green-700">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold text-orange-600 uppercase">Transcorridos</span><span id="stCorridos" class="text-[12px] font-black text-orange-600">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold text-red-600 uppercase">Saldo Dias</span><span id="stSaldo" class="text-[12px] font-black text-red-600">-</span></div>
                <div class="p-2"><span class="block text-[8px] font-bold text-slate-700 uppercase">HH Contrato</span><span id="stHH" class="text-[12px] font-black text-slate-900">-</span></div>
            </div>

            <table class="tab-bor mb-6">
                <thead>
                    <tr class="header-azul">
                        <th colspan="2">Indicadores de Desempenho</th>
                        <th class="w-20">Anterior</th>
                        <th>Seg <span id="dt-seg" class="sub-header-data"></span></th>
                        <th>Ter <span id="dt-ter" class="sub-header-data"></span></th>
                        <th>Qua <span id="dt-qua" class="sub-header-data"></span></th>
                        <th>Qui <span id="dt-qui" class="sub-header-data"></span></th>
                        <th>Sex <span id="dt-sex" class="sub-header-data"></span></th>
                        <th>Sab <span id="dt-sab" class="sub-header-data"></span></th>
                        <th>Dom <span id="dt-dom" class="sub-header-data"></span></th>
                        <th class="w-20">Semana</th>
                        <th class="w-24 bg-slate-900">Acumulado</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-4 flex flex-col gap-4">
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <div class="flex justify-between items-center border-b mb-2 pb-1">
                            <div class="text-[9px] font-bold uppercase text-blue-900">An√°lise de Planejamento</div>
                            <div class="flex gap-1">
                                <button onclick="ajustarFonte('obsPlan', 8)" class="btnFonte">8</button>
                                <button onclick="ajustarFonte('obsPlan', 10)" class="btnFonte">10</button>
                                <button onclick="ajustarFonte('obsPlan', 12)" class="btnFonte">12</button>
                            </div>
                        </div>
                        <textarea id="obsPlan"></textarea>
                    </div>
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <div class="flex justify-between items-center border-b mb-2 pb-1">
                            <div class="text-[9px] font-bold uppercase text-blue-900">Gest√£o de Engenharia</div>
                            <div class="flex gap-1">
                                <button onclick="ajustarFonte('obsEng', 8)" class="btnFonte">8</button>
                                <button onclick="ajustarFonte('obsEng', 10)" class="btnFonte">10</button>
                                <button onclick="ajustarFonte('obsEng', 12)" class="btnFonte">12</button>
                            </div>
                        </div>
                        <textarea id="obsEng"></textarea>
                    </div>
                </div>
                <div class="col-span-8 border p-4 bg-white rounded shadow-sm">
                    <div class="text-[10px] font-bold uppercase text-slate-400 text-center mb-4">Avan√ßo F√≠sico Acumulado (%)</div>
                    <div style="height: 260px; width: 100%;"><canvas id="chartCurva"></canvas></div>
                </div>
            </div>
        </div>

        <div id="telaProdutividade" class="painel-container hidden">
            <h2 class="text-2xl font-black text-blue-900 uppercase border-b-4 border-blue-900 mb-6 pb-2">Estudo de Produtividade Semanal</h2>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 border-l-4 border-blue-900 rounded shadow-sm">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">HH Gasto Total</span>
                    <div id="prodTotalGasto" class="text-2xl font-black text-slate-800">0,00</div>
                </div>
                <div class="bg-green-50 p-4 border-l-4 border-green-600 rounded shadow-sm">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">HH Agregado Total</span>
                    <div id="prodTotalAgregado" class="text-2xl font-black text-slate-800">0,00</div>
                </div>
                <div class="bg-slate-50 p-4 border-l-4 border-slate-900 rounded shadow-sm">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Produtividade Geral</span>
                    <div id="prodGeralPerc" class="text-2xl font-black text-blue-900">0%</div>
                </div>
                <div class="bg-red-50 p-4 border-l-4 border-red-600 rounded shadow-sm">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Total Horas Perdidas</span>
                    <div id="prodTotalPerdidas" class="text-2xl font-black text-red-600">0,00</div>
                </div>
            </div>
            <table class="tab-prod">
                <thead class="header-azul">
                    <tr>
                        <th class="py-3">Semana</th>
                        <th>HH Gasto Acum.</th>
                        <th>HH Agregado Acum.</th>
                        <th>HH Gasto Semana</th>
                        <th>HH Agregado Semana</th>
                        <th>Produtividade</th>
                        <th>Horas Perdidas</th>
                        <th>Acumulado</th>
                    </tr>
                </thead>
                <tbody id="corpoEstudoProdutividade"></tbody>
            </table>
        </div>
    </main>

    <div id="modalConfig">
        <div class="bg-white p-8 rounded shadow-2xl w-[450px]">
            <h2 class="text-xl font-bold mb-6 uppercase text-blue-900 border-b-2 border-blue-900 pb-2">Configura√ß√£o</h2>
            <div class="space-y-4 text-xs font-bold text-slate-600">
                <div><label>CLIENTE:</label><input type="text" id="cfgCliente" class="w-full border p-2 mt-1 rounded" value="Andritz - Klabin Puma II"></div>
                <div><label>OBRA:</label><input type="text" id="cfgObra" class="w-full border p-2 mt-1 rounded" value="Klabin Linha de Picagem 7"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label>IN√çCIO:</label><input type="date" id="cfgInicio" class="w-full border p-2 mt-1 rounded" value="2025-10-15"></div>
                    <div><label>T√âRMINO:</label><input type="date" id="cfgFim" class="w-full border p-2 mt-1 rounded" value="2026-06-19"></div>
                </div>
                <div><label>HH TOTAL CONTRATO:</label><input type="number" id="cfgHH" class="w-full border p-2 mt-1 rounded" value="88272.82"></div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="salvarConfig()" class="flex-1 bg-blue-900 text-white p-3 font-bold uppercase rounded hover:bg-blue-800 transition">Salvar</button>
                <button onclick="document.getElementById('modalConfig').style.display='none'" class="flex-1 bg-slate-200 text-slate-600 p-3 font-bold uppercase rounded">Sair</button>
            </div>
        </div>
    </div>

<script>
    Chart.register(ChartDataLabels);
    let curva = [], efetivo = [], semanaAtual = "", dbObs = {}, chartInstance = null;

    function ajustarFonte(id, tamanho) {
        document.getElementById(id).style.fontSize = tamanho + 'px';
    }

    function irPara(tela) {
        document.getElementById('telaPrincipal').classList.add('hidden');
        document.getElementById('telaProdutividade').classList.add('hidden');
        if(tela === 'principal') {
            document.getElementById('telaPrincipal').classList.remove('hidden');
            renderizarGrafico();
        } else {
            document.getElementById('telaProdutividade').classList.remove('hidden');
            gerarEstudoProdutividade();
        }
    }

    function handleLogo(inputId, imgId, txtId) {
        document.getElementById(inputId).onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById(imgId);
                    img.src = ev.target.result; img.classList.remove('hidden');
                    if(txtId) document.getElementById(txtId).classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };
    }
    document.getElementById('btnLogoEmpresa').onclick = () => document.getElementById('fLogoEmpresa').click();
    document.getElementById('btnLogoCliente').onclick = () => document.getElementById('fLogoCliente').click();
    handleLogo('fLogoEmpresa', 'imgEmpresa', null);
    handleLogo('fLogoCliente', 'imgCliente', 'txtLogoCliente');

    function carregarExcel(id, callback) {
        document.getElementById(id).onchange = e => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                callback(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
            };
            reader.readAsBinaryString(e.target.files[0]);
        };
    }
    carregarExcel('fCurva', data => { curva = data; atualizarSemanas(); renderizarGrafico(); });
    carregarExcel('fHH', data => { efetivo = data; processarPainel(); });

    function atualizarSemanas() {
        const s = [...new Set(curva.map(x=>x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
        const el = document.getElementById('selSemana'); el.innerHTML = '';
        s.forEach(x => el.add(new Option(x, x)));
        if(s.length) { 
            const u = curva.filter(x => x.Avanco_Realizado_Perc != null).pop();
            el.value = u ? u.Semana : s[0];
            processarPainel(); 
        }
    }

    document.getElementById('selSemana').onchange = () => { processarPainel(); renderizarGrafico(); };

    function processarPainel() {
        if(semanaAtual) dbObs[semanaAtual] = {p: document.getElementById('obsPlan').value, e: document.getElementById('obsEng').value};
        const sSel = document.getElementById('selSemana').value;
        if(!sSel) return;
        semanaAtual = sSel;
        document.getElementById('obsPlan').value = dbObs[sSel]?.p || "";
        document.getElementById('obsEng').value = dbObs[sSel]?.e || "";
        
        const hhTotal = parseFloat(document.getElementById('cfgHH').value) || 0;
        const dIni = new Date(document.getElementById('cfgInicio').value + "T12:00:00");
        const dFim = new Date(document.getElementById('cfgFim').value + "T12:00:00");
        const nSem = parseInt(sSel.replace(/\D/g,''));

        const dSegunda = new Date(dIni);
        const diaSemana = dIni.getDay(); 
        const ajusteSeg = diaSemana === 0 ? -6 : 1 - diaSemana;
        dSegunda.setDate(dIni.getDate() + ajusteSeg + (nSem * 7));

        ['dt-seg','dt-ter','dt-qua','dt-qui','dt-sex','dt-sab','dt-dom'].forEach((id, idx) => {
            let d = new Date(dSegunda); d.setDate(dSegunda.getDate() + idx);
            document.getElementById(id).innerText = d.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
        });

        let dDomingo = new Date(dSegunda); dDomingo.setDate(dSegunda.getDate() + 6);
        const prazoTotal = Math.floor((dFim - dIni) / (1000 * 60 * 60 * 24)) + 1;
        const hoje = new Date();
        const diasCorridos = Math.floor(((hoje < dDomingo ? hoje : dDomingo) - dIni) / (1000 * 60 * 60 * 24)) + 1;

        const cAnt = curva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSem);
        const rAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Realizado_Perc)||0),0);
        const pAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Previsto_Perc)||0),0);
        const hrAnt = efetivo.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSem).reduce((a,c)=>a+(parseFloat(c.HH_Real)||0),0);
        const haAnt = rAnt * hhTotal;

        let sP=0, sR=0, sHR=0, sHA=0, rP=[], rR=[], rHR=[], rHA=[], rPr=[];
        ['Seg','Ter','Qua','Qui','Sex','Sab','Dom'].forEach(d => {
            const c = curva.find(x => x.Semana === sSel && x.Dia.startsWith(d)) || {};
            const e = efetivo.find(x => x.Semana === sSel && x.Dia.startsWith(d)) || {};
            const vp = parseFloat(c.Avanco_Previsto_Perc)||0, vr = parseFloat(c.Avanco_Realizado_Perc)||0, vhr = parseFloat(e.HH_Real)||0;
            sP+=vp; sR+=vr; sHR+=vhr; sHA+=(vr*hhTotal);
            rP.push(vp); rR.push(vr); rHR.push(vhr); rHA.push(vr*hhTotal);
            rPr.push(vhr > 0 ? ((vr*hhTotal)/vhr) : 0);
        });

        const prodAcum = (hrAnt + sHR) > 0 ? ((haAnt + sHA) / (hrAnt + sHR)) : 0;

        document.getElementById('dspAvancoReal').innerText = ((rAnt + sR) * 100).toFixed(2) + "%";
        document.getElementById('dspHHRealAcm').innerText = (hrAnt + sHR).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('dspTempoPerc').innerText = ((diasCorridos / prazoTotal) * 100).toFixed(1) + "%";
        document.getElementById('dspDataDomingo').innerText = dDomingo.toLocaleDateString('pt-BR');
        document.getElementById('dspProdAcum').innerText = (prodAcum * 100).toFixed(1) + "%";

        document.getElementById('stDataInicio').innerText = dIni.toLocaleDateString('pt-BR');
        document.getElementById('stDataFim').innerText = dFim.toLocaleDateString('pt-BR');
        document.getElementById('stPrazo').innerText = prazoTotal + " DIAS";
        document.getElementById('stCorridos').innerText = diasCorridos + " DIAS";
        document.getElementById('stSaldo').innerText = (prazoTotal - diasCorridos) + " DIAS";
        document.getElementById('stHH').innerText = hhTotal.toLocaleString('pt-BR');

        const f = (v, p=false) => v === 0 ? '-' : (p ? (v*100).toFixed(2)+'%' : v.toLocaleString('pt-BR',{maximumFractionDigits:0}));
        document.getElementById('corpoTabela').innerHTML = `
            <tr class="font-bold"><td rowspan="2" class="bg-slate-50 text-[9px] uppercase">Avan√ßo %</td><td class="text-left px-2">Previsto</td><td class="text-slate-500 font-normal">${f(pAnt,true)}</td>${rP.map(v=>`<td class="font-normal text-slate-500">${f(v,true)}</td>`).join('')}<td>${f(sP,true)}</td><td class="bg-slate-100">${f(pAnt+sP,true)}</td></tr>
            <tr class="font-bold text-green-600"><td class="text-left px-2">Realizado</td><td>${f(rAnt,true)}</td>${rR.map(v=>`<td class="font-normal">${f(v,true)}</td>`).join('')}<td>${f(sR,true)}</td><td class="bg-green-50">${f(rAnt+sR,true)}</td></tr>
            <tr class="italic text-slate-600 bg-slate-50 font-bold"><td colspan="2" class="text-left px-2 uppercase">Produtividade</td><td>${hrAnt>0?((haAnt/hrAnt)*100).toFixed(1)+'%':'-'}</td>${rPr.map(v=>`<td>${v>0?(v*100).toFixed(1)+'%':'-'}</td>`).join('')}<td>${sHR>0?((sHA/sHR)*100).toFixed(1)+'%':'-'}</td><td class="bg-slate-200">${(prodAcum*100).toFixed(1)}%</td></tr>
            <tr><td colspan="2" class="text-left px-2 font-bold uppercase">HH Agregado</td><td>${f(haAnt)}</td>${rHA.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sHA)}</td><td class="bg-slate-50 font-bold">${f(haAnt+sHA)}</td></tr>
            <tr class="bg-blue-50/30"><td colspan="2" class="text-left px-2 font-bold uppercase">HH Real</td><td>${f(hrAnt)}</td>${rHR.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sHR)}</td><td class="bg-blue-100 font-bold">${f(hrAnt+sHR)}</td></tr>
        `;
    }

    // CORRE√á√ÉO DEFINITIVA DO GR√ÅFICO (100% E SEM GAPS)
    function renderizarGrafico() {
        const canvas = document.getElementById('chartCurva');
        if(!curva.length || !canvas) return;
        const ctx = canvas.getContext('2d');
        const sSel = document.getElementById('selSemana').value;
        const nSemSel = parseInt(sSel.replace(/\D/g,'') || 0);
        const todasSemanas = [...new Set(curva.map(x => x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));

        let prevAcm = 0, realAcm = 0, dP = [], dR = [];
        
        todasSemanas.forEach((sem, index) => {
            const d = curva.filter(x => x.Semana === sem);
            prevAcm += d.reduce((a,c) => a + (parseFloat(c.Avanco_Previsto_Perc)||0), 0);
            
            // FOR√áA 100% NO √öLTIMO PONTO DO PLANEJADO
            if (index === todasSemanas.length - 1) {
                dP.push(100);
            } else {
                dP.push(parseFloat((prevAcm * 100).toFixed(2)));
            }

            if(parseInt(sem.replace(/\D/g,'')) <= nSemSel) {
                realAcm += d.reduce((a,c) => a + (parseFloat(c.Avanco_Realizado_Perc)||0), 0);
                dR.push(parseFloat((realAcm * 100).toFixed(2)));
            }
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: todasSemanas,
                datasets: [
                    { 
                        label: 'Planejado', data: dP, borderColor: '#94a3b8', borderDash: [5,5], pointRadius: 0, tension: 0.1, fill: false,
                        datalabels: { display: false } 
                    },
                    { 
                        label: 'Realizado', data: dR, borderColor: '#10b981', borderWidth: 3, pointRadius: 3, tension: 0.1, fill: false,
                        datalabels: {
                            display: (c) => c.dataIndex === dR.length - 1,
                            align: 'top', anchor: 'end', offset: 8, font: { weight: 'bold', size: 10 }, color: '#065f46', 
                            backgroundColor: 'white', borderRadius: 3, padding: 2, formatter: v => v + '%'
                        }
                    }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                layout: { padding: { right: 35 } }, // ESPA√áO PARA O R√ìTULO FINAL
                plugins: { legend: { position: 'bottom' } }, 
                scales: { 
                    x: {
                        boundaryGap: false, // ENCOSTA A LINHA NAS BORDAS
                        ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 45 }
                    },
                    y: { 
                        min: 0, max: 100, 
                        ticks: { stepSize: 10, callback: v => v + '%' },
                        grid: { color: (ctx) => ctx.tick.value === 100 ? '#334155' : '#e2e8f0', lineWidth: (ctx) => ctx.tick.value === 100 ? 1.5 : 0.5 }
                    } 
                } 
            }
        });
    }

    function gerarEstudoProdutividade() {
        if(!curva.length) return;
        const hhTotal = parseFloat(document.getElementById('cfgHH').value) || 0;
        const semanas = [...new Set(curva.map(x=>x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
        let html = "", acmGasto = 0, acmAgregado = 0, totalPerdidas = 0;
        
        semanas.forEach(sem => {
            const cSem = curva.filter(x => x.Semana === sem);
            const eSem = efetivo.filter(x => x.Semana === sem);
            const realSem = cSem.reduce((a,c) => a + (parseFloat(c.Avanco_Realizado_Perc)||0), 0);
            const gastoSem = eSem.reduce((a,c) => a + (parseFloat(c.HH_Real)||0), 0);
            const agregSem = realSem * hhTotal;
            if(gastoSem === 0 && agregSem === 0) return;

            acmGasto += gastoSem;
            acmAgregado += agregSem;
            const prodSem = gastoSem > 0 ? (agregSem / gastoSem) : 0;
            const perdSem = agregSem < gastoSem ? (gastoSem - agregSem) : 0;
            const prodAcm = acmGasto > 0 ? (acmAgregado / acmGasto) : 0;
            totalPerdidas += perdSem;

            html += `<tr><td class="font-bold">${sem}</td><td>${acmGasto.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${acmAgregado.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${gastoSem.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${agregSem.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td class="font-bold ${prodSem < 1 ? 'text-red-600' : 'text-green-600'}">${(prodSem*100).toFixed(1)}%</td><td class="text-red-500">${perdSem > 0 ? perdSem.toLocaleString('pt-BR',{minimumFractionDigits:2}) : '-'}</td><td class="font-bold">${(prodAcm*100).toFixed(1)}%</td></tr>`;
        });

        document.getElementById('corpoEstudoProdutividade').innerHTML = html;
        document.getElementById('prodTotalGasto').innerText = acmGasto.toLocaleString('pt-BR', {minimumFractionDigits:2});
        document.getElementById('prodTotalAgregado').innerText = acmAgregado.toLocaleString('pt-BR', {minimumFractionDigits:2});
        document.getElementById('prodTotalPerdidas').innerText = totalPerdidas.toLocaleString('pt-BR', {minimumFractionDigits:2});
        document.getElementById('prodGeralPerc').innerText = (acmGasto > 0 ? (acmAgregado/acmGasto*100).toFixed(1) : 0) + "%";
    }

    function salvarConfig() {
        const c = document.getElementById('cfgCliente').value;
        const o = document.getElementById('cfgObra').value;
        document.getElementById('dspClienteObra').innerText = `${c.toUpperCase()} | ${o.toUpperCase()}`;
        document.getElementById('modalConfig').style.display='none';
        processarPainel();
    }
</script>
</body>
</html>