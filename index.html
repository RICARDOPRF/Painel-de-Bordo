<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo v23 - Upload Local</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        .sidebar { width: 260px; height: 100vh; position: fixed; background: #0f172a; color: white; }
        .conteudo { margin-left: 260px; padding: 20px; }
        .card-branco { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .tabela-obra { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .tabela-obra th, .tabela-obra td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; }
        .header-tabela { background: #1e3a8a; color: white; font-weight: bold; }
        .mini-label { font-size: 9px; text-transform: uppercase; opacity: 0.8; display: block; }
        .valor-destaque { font-size: 1.5rem; font-weight: 900; }
    </style>
</head>
<body>

<div class="sidebar p-6 flex flex-col gap-4">
    <h2 class="text-xl font-black border-b border-slate-700 pb-2 italic text-center text-blue-400">PAINEL OBRA</h2>
    <button onclick="document.getElementById('fCurva').click()" class="bg-blue-600 p-3 rounded font-bold hover:bg-blue-500 transition shadow-lg">üìÇ DADOS CURVA S</button>
    <button onclick="document.getElementById('fHH').click()" class="bg-emerald-600 p-3 rounded font-bold hover:bg-emerald-500 transition shadow-lg">üë∑ DADOS HH</button>
    <button onclick="abrirConfig()" class="bg-slate-700 p-3 rounded font-bold hover:bg-slate-600 transition shadow-lg">‚öôÔ∏è CONFIGURA√á√ÉO</button>
    <div class="mt-auto text-[10px] text-slate-500 italic text-center">v23.0 - Firebase Storage Active</div>
    <input type="file" id="fCurva" class="hidden" accept=".xlsx">
    <input type="file" id="fHH" class="hidden" accept=".xlsx">
</div>

<div class="conteudo">
    <div class="card-branco">
        <div class="flex justify-between items-center mb-6">
            <div class="w-48 h-20 border-2 border-dashed flex items-center justify-center p-2 rounded bg-slate-50">
                <img id="logoEmpresa" src="https://i.imgur.com/uGzX6Vp.png" class="max-h-full">
            </div>
            <div class="text-center">
                <h1 class="text-4xl font-black text-blue-900 uppercase tracking-tighter">Painel de Bordo</h1>
                <p id="infoClienteObra" class="text-sm font-bold text-slate-500 uppercase">Aguardando Sincroniza√ß√£o...</p>
            </div>
            <div class="w-48 h-20 border-2 border-dashed flex items-center justify-center p-2 rounded bg-slate-50">
                <img id="logoCliente" src="" class="max-h-full hidden">
                <span id="labelLogo" class="text-[10px] font-bold text-slate-400 uppercase">Logo Cliente</span>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-1 mb-1 shadow-sm">
            <div class="bg-blue-900 text-white p-4 text-center">
                <span class="mini-label">Avan√ßo Realizado</span>
                <span id="resAvanco" class="valor-destaque text-green-400">0.00%</span>
            </div>
            <div class="bg-blue-900 text-white p-4 text-center">
                <span class="mini-label">Produtividade Acum.</span>
                <span id="resProd" class="valor-destaque text-yellow-400">0%</span>
            </div>
            <div class="bg-blue-900 text-white p-4 text-center">
                <span class="mini-label">HH Real Acumulado</span>
                <span id="resHH" class="valor-destaque">0,00</span>
            </div>
            <div class="bg-blue-900 text-white p-4 text-center">
                <span class="mini-label text-blue-300 font-bold">Semana Ref.</span>
                <select id="selSemana" class="bg-transparent font-black text-xl outline-none w-full text-center cursor-pointer"></select>
            </div>
        </div>

        <div class="grid grid-cols-6 gap-1 mb-6 text-[10px] font-bold uppercase text-center border-b border-l border-r bg-white">
            <div class="p-2 border-r">In√≠cio<br><span id="datIni" class="text-blue-900 font-black">-</span></div>
            <div class="p-2 border-r">T√©rmino<br><span id="datFim" class="text-blue-900 font-black">-</span></div>
            <div class="p-2 border-r text-green-600">Prazo Total<br><span id="datPrazo">-</span></div>
            <div class="p-2 border-r text-orange-600">Transcorridos<br><span id="datTrans">-</span></div>
            <div class="p-2 border-r text-red-600">Saldo Dias<br><span id="datSaldo">-</span></div>
            <div class="p-2">HH Contrato<br><span id="datHH">-</span></div>
        </div>

        <table class="tabela-obra mb-6 shadow-sm">
            <thead class="header-tabela uppercase">
                <tr>
                    <th class="w-32">Indicadores</th><th class="w-20">Anterior</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sab</th><th>Dom</th><th>Semana</th><th class="bg-slate-900">Acumulado</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-4 space-y-4">
                <div class="bg-slate-50 border p-3 rounded">
                    <label class="mini-label font-black text-blue-900">An√°lise de Planejamento</label>
                    <textarea id="obsPlan" class="w-full h-24 border rounded mt-1 p-2 text-xs resize-none" oninput="salvarNotas()"></textarea>
                </div>
                <div class="bg-slate-50 border p-3 rounded">
                    <label class="mini-label font-black text-blue-900">Gest√£o de Engenharia</label>
                    <textarea id="obsEng" class="w-full h-24 border rounded mt-1 p-2 text-xs resize-none" oninput="salvarNotas()"></textarea>
                </div>
            </div>
            <div class="col-span-8 border p-4 bg-white rounded shadow-inner" style="height: 320px;">
                <canvas id="graficoCurva"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="modalCfg" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg w-[450px] shadow-2xl border-t-8 border-blue-900">
        <h3 class="font-black text-xl mb-6 text-blue-900 italic uppercase">Configura√ß√£o Geral</h3>
        <div class="grid grid-cols-1 gap-4 text-xs font-bold">
            <div class="flex flex-col"><label>CLIENTE:</label><input type="text" id="cCliente" class="border p-2 rounded"></div>
            <div class="flex flex-col"><label>OBRA:</label><input type="text" id="cObra" class="border p-2 rounded"></div>
            <div class="grid grid-cols-2 gap-2">
                <div class="flex flex-col"><label>IN√çCIO:</label><input type="date" id="cIni" class="border p-2 rounded"></div>
                <div class="flex flex-col"><label>FIM:</label><input type="date" id="cFim" class="border p-2 rounded"></div>
            </div>
            <div class="flex flex-col"><label>HH CONTRATO:</label><input type="number" id="cHH" class="border p-2 rounded"></div>
            
            <div class="flex flex-col p-3 bg-blue-50 rounded border-2 border-blue-100">
                <label class="text-blue-800">LOGO DO CLIENTE (JPEG/PNG):</label>
                <input type="file" id="cFileLogo" class="mt-2 text-[10px]" accept="image/jpeg, image/png">
                <span id="uploadMsg" class="text-[9px] mt-1 text-slate-500">Selecione para substituir a logo atual</span>
            </div>
        </div>
        <div class="flex gap-2 mt-8">
            <button id="btnSalvar" onclick="salvarTudo()" class="flex-1 bg-blue-900 text-white p-3 rounded font-black uppercase hover:bg-blue-800">Salvar Tudo</button>
            <button onclick="document.getElementById('modalCfg').classList.add('hidden')" class="flex-1 text-slate-400 font-bold">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAW35OKtqp0sp6vBgC3QsDyB31nfO6gQyo",
      authDomain: "painel-de-bordo-3f96a.firebaseapp.com",
      databaseURL: "https://painel-de-bordo-3f96a-default-rtdb.firebaseio.com",
      projectId: "painel-de-bordo-3f96a",
      storageBucket: "painel-de-bordo-3f96a.firebasestorage.app",
      messagingSenderId: "444721715892",
      appId: "1:444721715892:web:320c09972eac5632f3d5e1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    let dadosCurva = [], chart = null, logoAtualUrl = "";

    // --- SINCRONIZA√á√ÉO ---
    db.ref('painel').on('value', snap => {
        const d = snap.val() || {};
        if(d.config) {
            document.getElementById('infoClienteObra').innerText = `${d.config.cliente} | ${d.config.obra}`.toUpperCase();
            document.getElementById('datIni').innerText = invDat(d.config.inicio);
            document.getElementById('datFim').innerText = invDat(d.config.fim);
            document.getElementById('datHH').innerText = parseFloat(d.config.hh||0).toLocaleString('pt-BR');
            logoAtualUrl = d.config.logo || "";

            const ini = new Date(d.config.inicio);
            const fim = new Date(d.config.fim);
            const hoje = new Date();
            const total = Math.ceil((fim - ini) / 86400000);
            const trans = Math.ceil((hoje - ini) / 86400000);
            document.getElementById('datPrazo').innerText = (total||0) + " DIAS";
            document.getElementById('datTrans').innerText = (trans||0) + " DIAS";
            document.getElementById('datSaldo').innerText = ((total - trans)||0) + " DIAS";

            if(logoAtualUrl) {
                document.getElementById('logoCliente').src = logoAtualUrl;
                document.getElementById('logoCliente').classList.remove('hidden');
                document.getElementById('labelLogo').classList.add('hidden');
            }
        }
        dadosCurva = d.curva || [];
        if(dadosCurva.length > 0) { popularSems(); atualizarTudo(); }
    });

    function invDat(d) { return d ? d.split('-').reverse().join('/') : '-'; }

    async function salvarTudo() {
        const btn = document.getElementById('btnSalvar');
        const file = document.getElementById('cFileLogo').files[0];
        btn.disabled = true;
        btn.innerText = "ENVIANDO...";

        try {
            let urlLogo = logoAtualUrl;
            
            // Se o usu√°rio selecionou um arquivo JPEG/PNG
            if(file) {
                const ref = storage.ref('logos/cliente_logo');
                await ref.put(file);
                urlLogo = await ref.getDownloadURL();
            }

            const obj = {
                cliente: document.getElementById('cCliente').value,
                obra: document.getElementById('cObra').value,
                inicio: document.getElementById('cIni').value,
                fim: document.getElementById('cFim').value,
                hh: document.getElementById('cHH').value,
                logo: urlLogo
            };

            await db.ref('painel/config').set(obj);
            alert("Configura√ß√µes atualizadas com sucesso!");
            document.getElementById('modalCfg').classList.add('hidden');
        } catch(e) {
            alert("Erro ao salvar: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "SALVAR TUDO";
        }
    }

    // --- IMPORTA√á√ïES EXCEL ---
    function setupImp(id, path) {
        document.getElementById(id).onchange = e => {
            const reader = new FileReader();
            reader.onload = evt => {
                const wb = XLSX.read(evt.target.result, {type:'binary'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                db.ref(`painel/${path}`).set(json).then(() => alert("DADOS ATUALIZADOS!"));
            };
            reader.readAsBinaryString(e.target.files[0]);
        };
    }
    setupImp('fCurva', 'curva');
    setupImp('fHH', 'hh');

    // --- L√ìGICA GR√ÅFICOS/TABELA (IGUAL v22) ---
    function popularSems() {
        const sems = [...new Set(dadosCurva.map(x => x.Semana))].sort();
        const sel = document.getElementById('selSemana');
        const v = sel.value; sel.innerHTML = '';
        sems.forEach(s => sel.add(new Option(s, s)));
        sel.value = v || sems[sems.length-1];
    }
    document.getElementById('selSemana').onchange = atualizarTudo;

    function atualizarTudo() {
        const sSel = document.getElementById('selSemana').value;
        if(!sSel) return;
        const nSel = parseInt(sSel.replace(/\D/g,''));
        const realAcm = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) <= nSel).reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);
        document.getElementById('resAvanco').innerText = (realAcm * 100).toFixed(2) + "%";
        renderTabela(sSel, nSel);
        renderGrafico(nSel);
    }

    function renderTabela(sSel, nSel) {
        const dias = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
        const pAnt = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSel).reduce((a,c)=>a+(c.Avanco_Previsto_Perc||0),0);
        const rAnt = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSel).reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);
        let pSem=0, rSem=0;
        let html = `<tr><td class="font-bold bg-slate-50">Previsto (%)</td><td>${(pAnt*100).toFixed(2)}%</td>`;
        dias.forEach(d => {
            const v = dadosCurva.find(x => x.Semana === sSel && x.Dia.includes(d))?.Avanco_Previsto_Perc || 0;
            pSem += v; html += `<td>${(v*100).toFixed(2)}%</td>`;
        });
        html += `<td>${(pSem*100).toFixed(2)}%</td><td class="bg-slate-100 font-bold">${((pAnt+pSem)*100).toFixed(2)}%</td></tr>`;
        html += `<tr class="text-green-700 font-bold"><td class="bg-slate-50">Realizado (%)</td><td>${(rAnt*100).toFixed(2)}%</td>`;
        dias.forEach(d => {
            const v = dadosCurva.find(x => x.Semana === sSel && x.Dia.includes(d))?.Avanco_Realizado_Perc || 0;
            rSem += v; html += `<td>${(v*100).toFixed(2)}%</td>`;
        });
        html += `<td>${(rSem*100).toFixed(2)}%</td><td class="bg-green-50">${((rAnt+rSem)*100).toFixed(2)}%</td></tr>`;
        document.getElementById('corpoTabela').innerHTML = html;
    }

    function renderGrafico(nSel) {
        const ctx = document.getElementById('graficoCurva').getContext('2d');
        const sems = [...new Set(dadosCurva.map(x => x.Semana))].sort();
        let pAcm = 0, rAcm = 0, labels = [], dP = [], dR = [];
        sems.forEach(s => {
            labels.push(s);
            const d = dadosCurva.filter(x => x.Semana === s);
            pAcm += d.reduce((a,c)=>a+(c.Avanco_Previsto_Perc||0),0);
            dP.push((pAcm*100).toFixed(2));
            if(parseInt(s.replace(/\D/g,'')) <= nSel) {
                rAcm += d.reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);
                dR.push((rAcm*100).toFixed(2));
            }
        });
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Planejado', data: dP, borderColor: '#94a3b8', borderDash: [5,5], pointRadius: 0, fill: false },
                    { label: 'Realizado', data: dR, borderColor: '#10b981', borderWidth: 4, pointBackgroundColor: '#10b981' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function abrirConfig() {
        const d = db.ref('painel/config').once('value').then(snap => {
            const c = snap.val() || {};
            document.getElementById('cCliente').value = c.cliente || "";
            document.getElementById('cObra').value = c.obra || "";
            document.getElementById('cIni').value = c.inicio || "";
            document.getElementById('cFim').value = c.fim || "";
            document.getElementById('cHH').value = c.hh || "";
            document.getElementById('modalCfg').classList.remove('hidden');
        });
    }
</script>
</body>
</html>