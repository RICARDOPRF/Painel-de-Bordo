<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo Profissional - Empresa</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; display: flex; }
        #sidebar { transition: all 0.3s; width: 60px; z-index: 1000; overflow: hidden; height: 100vh; position: fixed; left: 0; top: 0; }
        #sidebar:hover { width: 260px; }
        .menu-label { opacity: 0; transition: opacity 0.2s; white-space: nowrap; font-size: 11px; font-weight: bold; }
        #sidebar:hover .menu-label { opacity: 1; }
        .painel-container { background: white; padding: 25px; border: 1px solid #cbd5e1; width: 1150px; margin: 20px auto; min-height: 800px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-bor, .tab-prod { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; border: 1.5px solid #1e293b; }
        .tab-bor th, .tab-bor td, .tab-prod th, .tab-prod td { border: 1px solid #cbd5e1; padding: 6px 2px; text-align: center; }
        .header-azul { background-color: #1e3a8a !important; color: white !important; font-weight: bold; text-transform: uppercase; }
        .logo-box { width: 180px; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 4px; }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .faixa-indicadores { background-color: #1e3a8a; color: white; display: flex; justify-content: space-around; padding: 12px; margin-bottom: 5px; border-radius: 4px; }
        .ind-item { text-align: center; border-right: 1px solid rgba(255,255,255,0.2); flex: 1; }
        .ind-value { font-size: 15px; font-weight: 800; display: block; }
        textarea { width: 100%; height: 90px; resize: none; border: 1px solid #e2e8f0; font-size: 11px; padding: 8px; border-radius: 4px; line-height: 1.4; }
        .btnFonte { padding: 2px 5px; font-size: 9px; border: 1px solid #cbd5e1; background: #fff; border-radius: 3px; cursor: pointer; font-weight: bold; color: #1e3a8a; }
        #modalConfig { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .sub-header-data { font-size: 8px; font-weight: bold; display: block; opacity: 0.8; }
        @media print { .no-print { display: none !important; } .painel-container { border: none; margin: 0; width: 100%; box-shadow: none; } }
    </style>
</head>
<body>

    <nav id="sidebar" class="bg-slate-900 flex flex-col text-white shadow-xl no-print">
        <div class="p-4 mb-6 border-b border-slate-700 flex items-center gap-4">
            <span class="text-xl">üìä</span><span class="menu-label uppercase">Painel de Bordo</span>
        </div>
        <div class="flex flex-col gap-4 px-3">
            <button onclick="irPara('principal')" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left">
                <span>üè†</span> <span class="menu-label uppercase">Painel de Bordo</span>
            </button>
            <button onclick="irPara('produtividade')" class="p-3 hover:bg-green-800 rounded flex items-center gap-4 transition text-left">
                <span>üìà</span> <span class="menu-label uppercase">Estudo Produtividade</span>
            </button>
            <hr class="border-slate-700">
            <button onclick="document.getElementById('modalConfig').style.display='flex'" class="p-3 hover:bg-blue-800 rounded flex items-center gap-4 transition text-left">
                <span>‚öôÔ∏è</span> <span class="menu-label uppercase">Configura√ß√£o</span>
            </button>
            <button onclick="document.getElementById('fCurva').click()" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left text-yellow-400">
                <span>üìÇ</span> <span class="menu-label uppercase">Importar Curva S</span>
            </button>
            <button onclick="document.getElementById('fHH').click()" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition text-left text-yellow-400">
                <span>üë∑</span> <span class="menu-label uppercase">Importar Dados HH</span>
            </button>
            <button onclick="gerarPDF()" class="p-3 hover:bg-red-800 rounded flex items-center gap-4 transition text-left">
                <span>üìÑ</span> <span class="menu-label uppercase">Exportar PDF</span>
            </button>
        </div>
    </nav>

    <input type="file" id="fLogoEmpresa" class="hidden" accept="image/*">
    <input type="file" id="fLogoCliente" class="hidden" accept="image/*">
    <input type="file" id="fCurva" accept=".xlsx" class="hidden">
    <input type="file" id="fHH" accept=".xlsx" class="hidden">

    <main class="flex-1 ml-[60px]">
        <div id="telaPrincipal" class="painel-container">
            <div class="flex justify-between items-center mb-4">
                <div onclick="document.getElementById('fLogoEmpresa').click()" class="logo-box cursor-pointer border border-dashed border-slate-200">
                    <img id="imgEmpresa" src="https://i.imgur.com/uGzX6Vp.png">
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-black uppercase tracking-tight text-blue-900">Painel de Bordo</h1>
                    <p id="dspClienteObra" class="text-[11px] font-bold text-slate-500 uppercase">CLIENTE | OBRA</p>
                </div>
                <div onclick="document.getElementById('fLogoCliente').click()" class="logo-box border border-dashed border-slate-300 rounded cursor-pointer">
                    <span id="txtLogoCliente" class="text-[9px] text-slate-400 font-bold uppercase">Logo Cliente</span>
                    <img id="imgCliente" class="hidden">
                </div>
            </div>

            <div class="faixa-indicadores">
                <div class="ind-item"><span>Avan√ßo Realizado</span><span class="ind-value text-green-400" id="dspAvancoReal">0.00%</span></div>
                <div class="ind-item"><span>Produtividade Acum.</span><span class="ind-value" id="dspProdAcum">0%</span></div>
                <div class="ind-item"><span>HH Real Acumulado</span><span class="ind-value text-yellow-300" id="dspHHRealAcm">0,00</span></div>
                <div class="ind-item"><span>Tempo Decorrido</span><span class="ind-value" id="dspTempoPerc">0%</span></div>
                <div class="ind-item"><span>Data de Corte</span><span class="ind-value" id="dspDataDomingo">-</span></div>
                <div class="ind-item bg-blue-950 px-2 rounded no-print">
                    <span class="text-[9px] text-blue-300 uppercase">Semana Ref.</span>
                    <select id="selSemana" class="bg-transparent text-white font-black outline-none w-full text-center cursor-pointer"></select>
                </div>
            </div>

            <div class="grid grid-cols-6 gap-0 text-center mb-4 border border-slate-300 bg-slate-50">
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold uppercase">In√≠cio</span><span id="stDataInicio" class="text-[12px] font-black text-blue-800">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold uppercase">T√©rmino</span><span id="stDataFim" class="text-[12px] font-black text-blue-800">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold uppercase text-green-700">Prazo Total</span><span id="stPrazo" class="text-[12px] font-black text-green-700">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold uppercase text-orange-600">Transcorridos</span><span id="stCorridos" class="text-[12px] font-black text-orange-600">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold uppercase text-red-600">Saldo Dias</span><span id="stSaldo" class="text-[12px] font-black text-red-600">-</span></div>
                <div class="p-2"><span class="block text-[8px] font-bold uppercase">HH Contrato</span><span id="stHH" class="text-[12px] font-black text-slate-900">-</span></div>
            </div>

            <table class="tab-bor mb-6">
                <thead>
                    <tr class="header-azul">
                        <th colspan="2">Indicadores de Desempenho</th>
                        <th class="w-20">Anterior</th>
                        <th>Seg <span id="dt-seg" class="sub-header-data"></span></th>
                        <th>Ter <span id="dt-ter" class="sub-header-data"></span></th>
                        <th>Qua <span id="dt-qua" class="sub-header-data"></span></th>
                        <th>Qui <span id="dt-qui" class="sub-header-data"></span></th>
                        <th>Sex <span id="dt-sex" class="sub-header-data"></span></th>
                        <th>Sab <span id="dt-sab" class="sub-header-data"></span></th>
                        <th>Dom <span id="dt-dom" class="sub-header-data"></span></th>
                        <th class="w-20">Semana</th>
                        <th class="w-24 bg-slate-900">Acumulado</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-4 flex flex-col gap-4">
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-[9px] font-bold uppercase">An√°lise de Planejamento</p>
                            <div class="flex gap-1 no-print">
                                <button onclick="ajustarFonte('obsPlan', 9)" class="btnFonte">9</button>
                                <button onclick="ajustarFonte('obsPlan', 11)" class="btnFonte">11</button>
                            </div>
                        </div>
                        <textarea id="obsPlan" onblur="salvarObs()"></textarea>
                    </div>
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-[9px] font-bold uppercase">Gest√£o de Engenharia</p>
                            <div class="flex gap-1 no-print">
                                <button onclick="ajustarFonte('obsEng', 9)" class="btnFonte">9</button>
                                <button onclick="ajustarFonte('obsEng', 11)" class="btnFonte">11</button>
                            </div>
                        </div>
                        <textarea id="obsEng" onblur="salvarObs()"></textarea>
                    </div>
                </div>
                <div class="col-span-8 border p-4 bg-white rounded shadow-sm">
                    <div style="height: 260px; width: 100%;"><canvas id="chartCurva"></canvas></div>
                </div>
            </div>
        </div>

        <div id="telaProdutividade" class="painel-container hidden">
            <h2 class="text-2xl font-black text-blue-900 uppercase border-b-4 border-blue-900 mb-6 pb-2">Estudo de Produtividade Semanal</h2>
            <div id="gridResumoProd" class="grid grid-cols-4 gap-4 mb-6">
                </div>
            <table class="tab-prod">
                <thead class="header-azul">
                    <tr>
                        <th class="py-2">Semana</th>
                        <th>HH Gasto Acum.</th>
                        <th>HH Agregado Acum.</th>
                        <th>HH Gasto Semana</th>
                        <th>HH Agregado Semana</th>
                        <th>Produtividade</th>
                        <th>Horas Perdidas</th>
                        <th>Acumulado</th>
                    </tr>
                </thead>
                <tbody id="corpoEstudoProdutividade"></tbody>
            </table>
        </div>
    </main>

    <div id="modalConfig">
        <div class="bg-white p-8 rounded shadow-2xl w-[450px]">
            <h2 class="text-xl font-bold mb-6 uppercase text-blue-900 border-b-2 border-blue-900 pb-2">Configura√ß√£o do Projeto</h2>
            <div class="space-y-4 text-xs font-bold text-slate-600">
                <div><label>CLIENTE:</label><input type="text" id="cfgCliente" class="w-full border p-2 mt-1 rounded"></div>
                <div><label>OBRA:</label><input type="text" id="cfgObra" class="w-full border p-2 mt-1 rounded"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label>IN√çCIO:</label><input type="date" id="cfgInicio" class="w-full border p-2 mt-1 rounded"></div>
                    <div><label>T√âRMINO:</label><input type="date" id="cfgFim" class="w-full border p-2 mt-1 rounded"></div>
                </div>
                <div><label>HH TOTAL CONTRATO:</label><input type="number" id="cfgHH" class="w-full border p-2 mt-1 rounded"></div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="salvarConfig()" class="flex-1 bg-blue-900 text-white p-3 font-bold uppercase rounded">Sincronizar Nuvem</button>
                <button onclick="document.getElementById('modalConfig').style.display='none'" class="flex-1 bg-slate-200 p-3 font-bold uppercase rounded">Sair</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG (Usando Realtime Database conforme solicitado anteriormente) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAW35OKtqp0sp6vBgC3QsDyB31nfO6gQyo",
      authDomain: "painel-de-bordo-3f96a.firebaseapp.com",
      databaseURL: "https://painel-de-bordo-3f96a-default-rtdb.firebaseio.com",
      projectId: "painel-de-bordo-3f96a",
      storageBucket: "painel-de-bordo-3f96a.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let curva = [], efetivo = [], chartInstance = null;
    Chart.register(ChartDataLabels);

    // --- FUN√á√ïES DE INTERFACE ---
    function ajustarFonte(id, tamanho) { document.getElementById(id).style.fontSize = tamanho + 'px'; }

    function irPara(tela) {
        document.getElementById('telaPrincipal').classList.toggle('hidden', tela !== 'principal');
        document.getElementById('telaProdutividade').classList.toggle('hidden', tela !== 'produtividade');
        if(tela === 'produtividade') gerarEstudoProdutividade();
    }

    // --- ESCUTA EM TEMPO REAL ---
    db.ref('painel').on('value', snap => {
        const d = snap.val() || {};
        
        if(d.config) {
            document.getElementById('cfgCliente').value = d.config.cliente || "";
            document.getElementById('cfgObra').value = d.config.obra || "";
            document.getElementById('cfgInicio').value = d.config.inicio || "";
            document.getElementById('cfgFim').value = d.config.fim || "";
            document.getElementById('cfgHH').value = d.config.hh || 0;
            document.getElementById('dspClienteObra').innerText = `${d.config.cliente} | ${d.config.obra}`.toUpperCase();
            if(d.config.logoEmpresaURL) document.getElementById('imgEmpresa').src = d.config.logoEmpresaURL;
            if(d.config.logoClienteURL) {
                document.getElementById('imgCliente').src = d.config.logoClienteURL;
                document.getElementById('imgCliente').classList.remove('hidden');
                document.getElementById('txtLogoCliente').classList.add('hidden');
            }
        }
        
        curva = d.curva || [];
        efetivo = d.hh || [];

        if(curva.length > 0) {
            const el = document.getElementById('selSemana');
            if(!el.options.length) {
                const s = [...new Set(curva.map(x=>x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
                el.innerHTML = '';
                s.forEach(x => el.add(new Option(x, x)));
                const u = curva.filter(x => x.Avanco_Realizado_Perc != null).pop();
                el.value = u ? u.Semana : s[0];
            }
            carregarObsSemana(el.value);
            processarPainel();
            renderizarGrafico();
            gerarEstudoProdutividade();
        }
    });

    // --- PERSIST√äNCIA DE ARQUIVOS ---
    function carregarExcel(id, pathDb) {
        document.getElementById(id).onchange = e => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                db.ref('painel/' + pathDb).set(data).then(() => alert(pathDb.toUpperCase() + " sincronizado na nuvem!"));
            };
            reader.readAsBinaryString(e.target.files[0]);
        };
    }
    carregarExcel('fCurva', 'curva');
    carregarExcel('fHH', 'hh');

    // --- LOGOS E OBSERVA√á√ïES ---
    async function uploadLogo(input, campo) {
        const file = input.files[0]; if(!file) return;
        const ref = storage.ref('logos/' + Date.now() + "_" + file.name);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        db.ref('painel/config').update({ [campo]: url });
    }
    document.getElementById('fLogoEmpresa').onchange = function() { uploadLogo(this, 'logoEmpresaURL'); };
    document.getElementById('fLogoCliente').onchange = function() { uploadLogo(this, 'logoClienteURL'); };

    function salvarObs() {
        const s = document.getElementById('selSemana').value;
        if(!s) return;
        db.ref('painel/observacoes/'+s).set({
            plan: document.getElementById('obsPlan').value,
            eng: document.getElementById('obsEng').value
        });
    }

    function carregarObsSemana(s) {
        db.ref('painel/observacoes/'+s).once('value', snap => {
            const d = snap.val() || {plan:"", eng:""};
            document.getElementById('obsPlan').value = d.plan;
            document.getElementById('obsEng').value = d.eng;
        });
    }

    document.getElementById('selSemana').onchange = (e) => {
        carregarObsSemana(e.target.value);
        processarPainel();
        renderizarGrafico();
    };

    // --- C√ÅLCULOS T√âCNICOS ---
    function processarPainel() {
        const sSel = document.getElementById('selSemana').value;
        if(!curva.length || !sSel) return;

        const hhContrato = parseFloat(document.getElementById('cfgHH').value) || 0;
        const dIni = new Date(document.getElementById('cfgInicio').value + "T12:00:00");
        const dFim = new Date(document.getElementById('cfgFim').value + "T12:00:00");
        const nSem = parseInt(sSel.replace(/\D/g,''));

        // Datas da Semana
        const dSegunda = new Date(dIni);
        const diaSem = dIni.getDay();
        const ajuste = diaSem === 0 ? -6 : 1 - diaSem;
        dSegunda.setDate(dIni.getDate() + ajuste + (nSem * 7));

        ['dt-seg','dt-ter','dt-qua','dt-qui','dt-sex','dt-sab','dt-dom'].forEach((id, idx) => {
            let d = new Date(dSegunda); d.setDate(dSegunda.getDate() + idx);
            document.getElementById(id).innerText = d.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
        });

        // Prazos
        const dDom = new Date(dSegunda); dDom.setDate(dSegunda.getDate() + 6);
        const prazoTotal = Math.floor((dFim - dIni) / 86400000) + 1;
        const hoje = new Date();
        const diasCorridos = Math.floor(((hoje < dDom ? hoje : dDom) - dIni) / 86400000) + 1;

        document.getElementById('stDataInicio').innerText = dIni.toLocaleDateString('pt-BR');
        document.getElementById('stDataFim').innerText = dFim.toLocaleDateString('pt-BR');
        document.getElementById('stPrazo').innerText = prazoTotal + " DIAS";
        document.getElementById('stCorridos').innerText = (diasCorridos > prazoTotal ? prazoTotal : diasCorridos) + " DIAS";
        document.getElementById('stSaldo').innerText = Math.max(0, prazoTotal - diasCorridos) + " DIAS";
        document.getElementById('stHH').innerText = hhContrato.toLocaleString('pt-BR');
        document.getElementById('dspTempoPerc').innerText = ((diasCorridos / prazoTotal) * 100).toFixed(1) + "%";
        document.getElementById('dspDataDomingo').innerText = dDom.toLocaleDateString('pt-BR');

        // Acumulados
        const cAnt = curva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSem);
        const rAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Realizado_Perc)||0),0);
        const pAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Previsto_Perc)||0),0);
        const hrAnt = efetivo.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSem).reduce((a,c)=>a+(parseFloat(c.HH_Real)||0),0);
        const haAnt = rAnt * hhContrato;

        let sP=0, sR=0, sHR=0, sHA=0, rP=[], rR=[], rHR=[], rHA=[];
        ['Seg','Ter','Qua','Qui','Sex','Sab','Dom'].forEach(d => {
            const c = curva.find(x => x.Semana === sSel && x.Dia.startsWith(d)) || {};
            const e = efetivo.find(x => x.Semana === sSel && x.Dia.startsWith(d)) || {};
            const vp = parseFloat(c.Avanco_Previsto_Perc)||0, vr = parseFloat(c.Avanco_Realizado_Perc)||0, vhr = parseFloat(e.HH_Real)||0;
            sP+=vp; sR+=vr; sHR+=vhr; sHA+=(vr*hhContrato);
            rP.push(vp); rR.push(vr); rHR.push(vhr); rHA.push(vr*hhContrato);
        });

        const f = (v, p=false) => p ? (v*100).toFixed(2)+'%' : v.toLocaleString('pt-BR', {maximumFractionDigits:0});
        document.getElementById('corpoTabela').innerHTML = `
            <tr class="font-bold"><td>Avan√ßo %</td><td>Previsto</td><td class="text-slate-500 font-normal">${f(pAnt,true)}</td>${rP.map(v=>`<td class="font-normal text-slate-500">${f(v,true)}</td>`).join('')}<td>${f(sP,true)}</td><td class="bg-slate-100">${f(pAnt+sP,true)}</td></tr>
            <tr class="font-bold text-green-600"><td>Avan√ßo %</td><td>Realizado</td><td>${f(rAnt,true)}</td>${rR.map(v=>`<td class="font-normal">${f(v,true)}</td>`).join('')}<td>${f(sR,true)}</td><td class="bg-green-50">${f(rAnt+sR,true)}</td></tr>
            <tr><td colspan="2" class="text-left px-2 font-bold uppercase">HH Agregado</td><td>${f(haAnt)}</td>${rHA.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sHA)}</td><td class="bg-slate-50 font-bold">${f(haAnt+sHA)}</td></tr>
            <tr class="bg-blue-50/30"><td colspan="2" class="text-left px-2 font-bold uppercase">HH Real</td><td>${f(hrAnt)}</td>${rHR.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sHR)}</td><td class="bg-blue-100 font-bold">${f(hrAnt+sHR)}</td></tr>
        `;

        document.getElementById('dspAvancoReal').innerText = f(rAnt+sR, true);
        document.getElementById('dspHHRealAcm').innerText = (hrAnt+sHR).toLocaleString('pt-BR', {minimumFractionDigits:2});
        const prodAcm = (hrAnt+sHR) > 0 ? ((haAnt+sHA)/(hrAnt+sHR)) : 0;
        document.getElementById('dspProdAcum').innerText = (prodAcm*100).toFixed(1) + "%";
    }

    function renderizarGrafico() {
        const canvas = document.getElementById('chartCurva');
        if(!curva.length || !canvas) return;
        const ctx = canvas.getContext('2d');
        const sSel = document.getElementById('selSemana').value;
        const nSemSel = parseInt(sSel.replace(/\D/g,'') || 0);
        const todasSemanas = [...new Set(curva.map(x => x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));

        let prevAcm = 0, realAcm = 0, dP = [], dR = [];
        todasSemanas.forEach((sem, index) => {
            const d = curva.filter(x => x.Semana === sem);
            prevAcm += d.reduce((a,c) => a + (parseFloat(c.Avanco_Previsto_Perc)||0), 0);
            dP.push(index === todasSemanas.length - 1 ? 100 : parseFloat((prevAcm * 100).toFixed(2)));
            if(parseInt(sem.replace(/\D/g,'')) <= nSemSel) {
                realAcm += d.reduce((a,c) => a + (parseFloat(c.Avanco_Realizado_Perc)||0), 0);
                dR.push(parseFloat((realAcm * 100).toFixed(2)));
            }
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: todasSemanas, datasets: [
                { label: 'Planejado', data: dP, borderColor: '#94a3b8', borderDash: [5,5], pointRadius: 0, tension: 0.1, fill: false },
                { label: 'Realizado', data: dR, borderColor: '#10b981', borderWidth: 3, pointRadius: 3, tension: 0.1, fill: false }
            ]},
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { position: 'bottom' }, datalabels: { display: false } },
                scales: { 
                    x: { boundaryGap: false, ticks: { font: { size: 9 } } },
                    y: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
                } 
            }
        });
    }

    function gerarEstudoProdutividade() {
        if(!curva.length) return;
        const hhTotal = parseFloat(document.getElementById('cfgHH').value) || 0;
        const semanas = [...new Set(curva.map(x=>x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
        let html = "", acmGasto = 0, acmAgregado = 0, totalPerdidas = 0;
        
        semanas.forEach(sem => {
            const realSem = curva.filter(x => x.Semana === sem).reduce((a,c) => a + (parseFloat(c.Avanco_Realizado_Perc)||0), 0);
            const gastoSem = efetivo.filter(x => x.Semana === sem).reduce((a,c) => a + (parseFloat(c.HH_Real)||0), 0);
            const agregSem = realSem * hhTotal;
            if(gastoSem === 0 && agregSem === 0) return;

            acmGasto += gastoSem; acmAgregado += agregSem;
            const prodSem = gastoSem > 0 ? (agregSem / gastoSem) : 0;
            const perdSem = agregSem < gastoSem ? (gastoSem - agregSem) : 0;
            const prodAcm = acmGasto > 0 ? (acmAgregado / acmGasto) : 0;
            totalPerdidas += perdSem;

            html += `<tr><td class="font-bold">${sem}</td><td>${fNum(acmGasto)}</td><td>${fNum(acmAgregado)}</td><td>${fNum(gastoSem)}</td><td>${fNum(agregSem)}</td><td class="font-bold ${(prodSem < 0.85 ? 'text-red-600' : 'text-green-600')}">${(prodSem*100).toFixed(1)}%</td><td class="text-red-500">${perdSem > 0 ? fNum(perdSem) : '-'}</td><td class="font-bold">${(prodAcm*100).toFixed(1)}%</td></tr>`;
        });

        document.getElementById('corpoEstudoProdutividade').innerHTML = html;
        document.getElementById('gridResumoProd').innerHTML = `
            <div class="bg-blue-50 p-4 border-l-4 border-blue-900 rounded shadow-sm"><span class="text-[10px] font-bold text-slate-500 uppercase">HH Gasto Total</span><div class="text-xl font-black">${fNum(acmGasto)}</div></div>
            <div class="bg-green-50 p-4 border-l-4 border-green-600 rounded shadow-sm"><span class="text-[10px] font-bold text-slate-500 uppercase">HH Agregado Total</span><div class="text-xl font-black">${fNum(acmAgregado)}</div></div>
            <div class="bg-slate-50 p-4 border-l-4 border-slate-900 rounded shadow-sm"><span class="text-[10px] font-bold text-slate-500 uppercase">Produtividade Geral</span><div class="text-xl font-black text-blue-900">${(acmGasto > 0 ? (acmAgregado/acmGasto*100).toFixed(1) : 0)}%</div></div>
            <div class="bg-red-50 p-4 border-l-4 border-red-600 rounded shadow-sm"><span class="text-[10px] font-bold text-slate-500 uppercase">Total Horas Perdidas</span><div class="text-xl font-black text-red-600">${fNum(totalPerdidas)}</div></div>
        `;
    }

    const fNum = v => v.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});

    function salvarConfig() {
        const c = {
            cliente: document.getElementById('cfgCliente').value,
            obra: document.getElementById('cfgObra').value,
            inicio: document.getElementById('cfgInicio').value,
            fim: document.getElementById('cfgFim').value,
            hh: document.getElementById('cfgHH').value
        };
        db.ref('painel/config').update(c).then(() => {
            document.getElementById('modalConfig').style.display = 'none';
            alert("Sincronizado com sucesso!");
        });
    }

    function gerarPDF() {
        const opt = { margin: 5, filename: 'Relatorio_Painel.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' } };
        html2pdf().set(opt).from(document.body).save();
    }
</script>
</body>
</html>