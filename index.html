<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo - Persist√™ncia Total</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; display: flex; }
        #sidebar { transition: all 0.3s; width: 60px; z-index: 1000; overflow: hidden; height: 100vh; position: fixed; left: 0; top: 0; }
        #sidebar:hover { width: 260px; }
        .menu-label { opacity: 0; transition: opacity 0.2s; white-space: nowrap; font-size: 11px; font-weight: bold; }
        #sidebar:hover .menu-label { opacity: 1; }
        .painel-container { background: white; padding: 25px; border: 1px solid #cbd5e1; width: 1150px; margin: 20px auto; min-height: 800px; }
        .tab-bor, .tab-prod { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; border: 1.5px solid #1e293b; }
        .tab-bor th, .tab-bor td, .tab-prod th, .tab-prod td { border: 1px solid #cbd5e1; padding: 6px 2px; text-align: center; }
        .header-azul { background-color: #1e3a8a !important; color: white !important; font-weight: bold; text-transform: uppercase; }
        .logo-box { width: 180px; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fff; }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .faixa-indicadores { background-color: #1e3a8a; color: white; display: flex; justify-content: space-around; padding: 12px; margin-bottom: 5px; }
        .ind-item { text-align: center; border-right: 1px solid rgba(255,255,255,0.2); flex: 1; }
        .ind-value { font-size: 15px; font-weight: 800; display: block; }
        textarea { width: 100%; height: 90px; resize: none; border-radius: 4px; border: 1px solid #e2e8f0; font-size: 11px; padding: 8px; }
        .hidden { display: none !important; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

    <nav id="sidebar" class="bg-slate-900 flex flex-col text-white shadow-xl no-print">
        <div class="p-4 mb-6 border-b border-slate-700 flex items-center gap-4">
            <span class="text-xl">üìä</span><span class="menu-label">PAINEL EMPRESA</span>
        </div>
        <div class="flex flex-col gap-4 px-3">
            <button onclick="irPara('principal')" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition">
                <span>üè†</span> <span class="menu-label">PAINEL PRINCIPAL</span>
            </button>
            <button onclick="irPara('produtividade')" class="p-3 hover:bg-green-800 rounded flex items-center gap-4 transition">
                <span>üìà</span> <span class="menu-label">PRODUTIVIDADE</span>
            </button>
            <hr class="border-slate-700">
            <button onclick="document.getElementById('fCurva').click()" class="p-3 hover:bg-blue-700 rounded flex items-center gap-4 transition text-yellow-400">
                <span>üìÇ</span> <span class="menu-label">SUBIR CURVA S (EXCEL)</span>
            </button>
            <button onclick="document.getElementById('fHH').click()" class="p-3 hover:bg-blue-700 rounded flex items-center gap-4 transition text-yellow-400">
                <span>üë∑</span> <span class="menu-label">SUBIR HH (EXCEL)</span>
            </button>
            <hr class="border-slate-700">
            <button onclick="document.getElementById('modalConfig').style.display='flex'" class="p-3 hover:bg-slate-700 rounded flex items-center gap-4 transition">
                <span>‚öôÔ∏è</span> <span class="menu-label">CONFIGURA√á√ïES</span>
            </button>
            <button onclick="gerarPDF()" class="p-3 hover:bg-red-800 rounded flex items-center gap-4 transition">
                <span>üìÑ</span> <span class="menu-label">GERAR PDF</span>
            </button>
        </div>
    </nav>

    <input type="file" id="fLogoEmpresa" class="hidden" accept="image/*">
    <input type="file" id="fLogoCliente" class="hidden" accept="image/*">
    <input type="file" id="fCurva" accept=".xlsx" class="hidden">
    <input type="file" id="fHH" accept=".xlsx" class="hidden">

    <main class="flex-1 ml-[60px]">
        <div id="telaPrincipal" class="painel-container">
            <div class="flex justify-between items-center mb-4">
                <div onclick="document.getElementById('fLogoEmpresa').click()" class="logo-box cursor-pointer border border-dashed border-slate-200">
                    <img id="imgEmpresa" src="https://i.imgur.com/uGzX6Vp.png">
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-black uppercase text-blue-900">Painel de Bordo</h1>
                    <p id="dspClienteObra" class="text-[11px] font-bold text-slate-500 uppercase">CLIENTE | OBRA</p>
                </div>
                <div onclick="document.getElementById('fLogoCliente').click()" class="logo-box border border-dashed border-slate-300 rounded cursor-pointer">
                    <span id="txtLogoCliente" class="text-[9px] text-slate-400 font-bold uppercase">Logo Cliente</span>
                    <img id="imgCliente" class="hidden">
                </div>
            </div>

            <div class="faixa-indicadores">
                <div class="ind-item"><span class="text-[9px] uppercase">Avan√ßo Realizado</span><span class="ind-value text-green-400" id="dspAvancoReal">0.00%</span></div>
                <div class="ind-item"><span class="text-[9px] uppercase">Produtividade Acum.</span><span class="ind-value" id="dspProdAcum">0%</span></div>
                <div class="ind-item"><span class="text-[9px] uppercase">HH Real Acumulado</span><span class="ind-value text-yellow-300" id="dspHHRealAcm">0,00</span></div>
                <div class="ind-item"><span class="text-[9px] uppercase">Tempo Decorrido</span><span class="ind-value" id="dspTempoPerc">0%</span></div>
                <div class="ind-item bg-blue-950 px-2 rounded no-print">
                    <span class="text-[9px] text-blue-300 block">Semana Ref.</span>
                    <select id="selSemana" class="bg-transparent text-white font-black outline-none w-full"></select>
                </div>
            </div>

            <div class="grid grid-cols-6 gap-0 text-center mb-4 border border-slate-300 bg-slate-50">
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold">In√≠cio</span><span id="stDataInicio" class="text-[12px] font-black">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold">T√©rmino</span><span id="stDataFim" class="text-[12px] font-black">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold">Prazo</span><span id="stPrazo" class="text-[12px] font-black">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold">Corridos</span><span id="stCorridos" class="text-[12px] font-black">-</span></div>
                <div class="border-r border-slate-300 p-2"><span class="block text-[8px] font-bold">Saldo</span><span id="stSaldo" class="text-[12px] font-black">-</span></div>
                <div class="p-2"><span class="block text-[8px] font-bold">HH Contrato</span><span id="stHH" class="text-[12px] font-black">-</span></div>
            </div>

            <table class="tab-bor mb-6">
                <thead>
                    <tr class="header-azul">
                        <th colspan="2">Indicadores</th>
                        <th class="w-20">Anterior</th>
                        <th>Seg <span id="dt-seg" class="sub-header-data"></span></th>
                        <th>Ter <span id="dt-ter" class="sub-header-data"></span></th>
                        <th>Qua <span id="dt-qua" class="sub-header-data"></span></th>
                        <th>Qui <span id="dt-qui" class="sub-header-data"></span></th>
                        <th>Sex <span id="dt-sex" class="sub-header-data"></span></th>
                        <th>Sab <span id="dt-sab" class="sub-header-data"></span></th>
                        <th>Dom <span id="dt-dom" class="sub-header-data"></span></th>
                        <th class="w-20">Semana</th>
                        <th class="w-24 bg-slate-900">Acumulado</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-4 flex flex-col gap-4">
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <p class="text-[9px] font-bold uppercase mb-1">An√°lise de Planejamento</p>
                        <textarea id="obsPlan" onblur="salvarObs()"></textarea>
                    </div>
                    <div class="border p-3 bg-slate-50 rounded shadow-sm">
                        <p class="text-[9px] font-bold uppercase mb-1">Gest√£o de Engenharia</p>
                        <textarea id="obsEng" onblur="salvarObs()"></textarea>
                    </div>
                </div>
                <div class="col-span-8 border p-4 bg-white rounded shadow-sm">
                    <div style="height: 260px;"><canvas id="chartCurva"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalConfig">
        <div class="bg-white p-8 rounded shadow-2xl w-[450px]">
            <h2 class="text-xl font-bold mb-6 text-blue-900">CONFIGURA√á√ÉO</h2>
            <div class="space-y-4 text-xs font-bold">
                <div><label>CLIENTE:</label><input type="text" id="cfgCliente" class="w-full border p-2 mt-1 rounded"></div>
                <div><label>OBRA:</label><input type="text" id="cfgObra" class="w-full border p-2 mt-1 rounded"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label>IN√çCIO:</label><input type="date" id="cfgInicio" class="w-full border p-2 mt-1 rounded"></div>
                    <div><label>T√âRMINO:</label><input type="date" id="cfgFim" class="w-full border p-2 mt-1 rounded"></div>
                </div>
                <div><label>HH TOTAL CONTRATO:</label><input type="number" id="cfgHH" class="w-full border p-2 mt-1 rounded"></div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="salvarConfig()" class="flex-1 bg-blue-900 text-white p-3 rounded">SALVAR</button>
                <button onclick="document.getElementById('modalConfig').style.display='none'" class="flex-1 bg-slate-200 p-3 rounded">SAIR</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAW35OKtqp0sp6vBgC3QsDyB31nfO6gQyo",
      authDomain: "painel-de-bordo-3f96a.firebaseapp.com",
      databaseURL: "https://painel-de-bordo-3f96a-default-rtdb.firebaseio.com",
      projectId: "painel-de-bordo-3f96a",
      storageBucket: "painel-de-bordo-3f96a.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let curva = [], efetivo = [], chartInstance = null;

    // --- ESCUTA O FIREBASE EM TEMPO REAL ---
    db.ref('painel').on('value', snap => {
        const d = snap.val() || {};
        if(d.config) {
            document.getElementById('cfgCliente').value = d.config.cliente || "";
            document.getElementById('cfgObra').value = d.config.obra || "";
            document.getElementById('cfgInicio').value = d.config.inicio || "";
            document.getElementById('cfgFim').value = d.config.fim || "";
            document.getElementById('cfgHH').value = d.config.hh || 0;
            document.getElementById('dspClienteObra').innerText = `${d.config.cliente} | ${d.config.obra}`.toUpperCase();
            if(d.config.logoEmpresaURL) document.getElementById('imgEmpresa').src = d.config.logoEmpresaURL;
            if(d.config.logoClienteURL) {
                document.getElementById('imgCliente').src = d.config.logoClienteURL;
                document.getElementById('imgCliente').classList.remove('hidden');
                document.getElementById('txtLogoCliente').classList.add('hidden');
            }
        }
        
        // Sincroniza tabelas
        if(d.curva) curva = d.curva;
        if(d.hh) efetivo = d.hh;

        if(curva.length > 0) {
            if(!document.getElementById('selSemana').options.length) {
                atualizarSemanas();
            }
            processarPainel();
            renderizarGrafico();
        }
    });

    // --- LOGICA DE EXCEL COM SALVAMENTO NO FIREBASE ---
    function carregarExcel(id, pathDb) {
        document.getElementById(id).onchange = e => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // GRAVA NO FIREBASE (Limpa o antigo e p√µe o novo)
                db.ref('painel/' + pathDb).set(data).then(() => {
                    alert("Dados salvos na nuvem com sucesso!");
                });
            };
            reader.readAsBinaryString(e.target.files[0]);
        };
    }
    carregarExcel('fCurva', 'curva');
    carregarExcel('fHH', 'hh');

    // --- LOGOS ---
    async function uploadLogo(input, campo) {
        const file = input.files[0];
        if(!file) return;
        const ref = storage.ref('logos/' + file.name);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        db.ref('painel/config').update({ [campo]: url });
    }
    document.getElementById('fLogoEmpresa').onchange = function() { uploadLogo(this, 'logoEmpresaURL'); };
    document.getElementById('fLogoCliente').onchange = function() { uploadLogo(this, 'logoClienteURL'); };

    // --- OBSERVA√á√ïES ---
    function salvarObs() {
        const s = document.getElementById('selSemana').value;
        if(!s) return;
        db.ref('painel/observacoes/'+s).set({
            plan: document.getElementById('obsPlan').value,
            eng: document.getElementById('obsEng').value
        });
    }

    document.getElementById('selSemana').onchange = () => {
        const s = document.getElementById('selSemana').value;
        db.ref('painel/observacoes/'+s).once('value', snap => {
            const d = snap.val() || {plan:"", eng:""};
            document.getElementById('obsPlan').value = d.plan;
            document.getElementById('obsEng').value = d.eng;
        });
        processarPainel();
        renderizarGrafico();
    };

    // --- C√ÅLCULOS E GR√ÅFICO (REUTILIZADOS DA VERAO ANTERIOR) ---
    function atualizarSemanas() {
        const s = [...new Set(curva.map(x=>x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
        const el = document.getElementById('selSemana'); el.innerHTML = '';
        s.forEach(x => el.add(new Option(x, x)));
        const u = curva.filter(x => x.Avanco_Realizado_Perc != null).pop();
        el.value = u ? u.Semana : s[0];
    }

    function processarPainel() {
        const sSel = document.getElementById('selSemana').value;
        if(!curva.length || !sSel) return;
        
        const hhTotal = parseFloat(document.getElementById('cfgHH').value) || 0;
        const dIni = new Date(document.getElementById('cfgInicio').value + "T12:00:00");
        const dFim = new Date(document.getElementById('cfgFim').value + "T12:00:00");
        const nSem = parseInt(sSel.replace(/\D/g,''));

        const prazoTotal = Math.floor((dFim - dIni) / (86400000)) + 1;
        const hoje = new Date();
        const diasCorridos = Math.floor((hoje - dIni) / (86400000)) + 1;

        // C√°lculos de Avan√ßo
        const cAnt = curva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSem);
        const rAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Realizado_Perc)||0),0);
        const pAnt = cAnt.reduce((a,c)=>a+(parseFloat(c.Avanco_Previsto_Perc)||0),0);
        
        // Render Tabela (Simplificado aqui para manter foco na persist√™ncia)
        let sP=0, sR=0, rP=[], rR=[];
        ['Seg','Ter','Qua','Qui','Sex','Sab','Dom'].forEach(d => {
            const c = curva.find(x => x.Semana === sSel && x.Dia.startsWith(d)) || {};
            const vp = parseFloat(c.Avanco_Previsto_Perc)||0, vr = parseFloat(c.Avanco_Realizado_Perc)||0;
            sP+=vp; sR+=vr; rP.push(vp); rR.push(vr);
        });

        document.getElementById('dspAvancoReal').innerText = ((rAnt + sR) * 100).toFixed(2) + "%";
        document.getElementById('stPrazo').innerText = prazoTotal + " DIAS";
        document.getElementById('stCorridos').innerText = (diasCorridos > prazoTotal ? prazoTotal : diasCorridos) + " DIAS";
        document.getElementById('stSaldo').innerText = (prazoTotal - diasCorridos < 0 ? 0 : prazoTotal - diasCorridos) + " DIAS";
        
        const f = (v) => (v*100).toFixed(2)+'%';
        document.getElementById('corpoTabela').innerHTML = `
            <tr><td>Previsto</td><td>${f(pAnt)}</td>${rP.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sP)}</td><td class="bg-slate-100 font-bold">${f(pAnt+sP)}</td></tr>
            <tr class="text-green-600 font-bold"><td>Realizado</td><td>${f(rAnt)}</td>${rR.map(v=>`<td>${f(v)}</td>`).join('')}<td>${f(sR)}</td><td class="bg-green-50">${f(rAnt+sR)}</td></tr>
        `;
    }

    function renderizarGrafico() {
        const ctx = document.getElementById('chartCurva').getContext('2d');
        const todasSemanas = [...new Set(curva.map(x => x.Semana))].sort((a,b)=> parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));
        let pA=0, rA=0, dP=[], dR=[];
        const nSel = parseInt(document.getElementById('selSemana').value.replace(/\D/g,''));

        todasSemanas.forEach(s => {
            const d = curva.filter(x => x.Semana === s);
            pA += d.reduce((a,c)=>a+(parseFloat(c.Avanco_Previsto_Perc)||0),0);
            dP.push((pA*100).toFixed(2));
            if(parseInt(s.replace(/\D/g,'')) <= nSel) {
                rA += d.reduce((a,c)=>a+(parseFloat(c.Avanco_Realizado_Perc)||0),0);
                dR.push((rA*100).toFixed(2));
            }
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: todasSemanas, datasets: [
                { label: 'Planejado', data: dP, borderColor: '#cbd5e1', borderDash:[5,5], pointRadius:0, fill:false },
                { label: 'Realizado', data: dR, borderColor: '#10b981', borderWidth:3, fill:false }
            ]},
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    function salvarConfig() {
        const c = {
            cliente: document.getElementById('cfgCliente').value,
            obra: document.getElementById('cfgObra').value,
            inicio: document.getElementById('cfgInicio').value,
            fim: document.getElementById('cfgFim').value,
            hh: document.getElementById('cfgHH').value
        };
        db.ref('painel/config').set(c).then(() => {
            document.getElementById('modalConfig').style.display='none';
            alert("Configura√ß√µes salvas!");
        });
    }

    function gerarPDF() {
        const el = document.getElementById('telaPrincipal');
        html2pdf().set({ margin: 10, filename: 'Relatorio_Obra.pdf', jsPDF: { format: 'a3', orientation: 'landscape' } }).from(el).save();
    }

    function irPara(t) {
        // L√≥gica de troca de tela omitida para brevidade, mas segue o padr√£o anterior
        alert("Navegando para: " + t);
    }
</script>
</body>
</html>