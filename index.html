<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo v21</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; }
        .sidebar { width: 250px; height: 100vh; position: fixed; background: #0f172a; color: white; transition: 0.3s; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); padding: 20px; }
        .tab-bor { width: 100%; border-collapse: collapse; font-size: 12px; }
        .tab-bor th, .tab-bor td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        .header-azul { background: #1e3a8a; color: white; }
    </style>
</head>
<body>

<div class="sidebar p-4 space-y-4">
    <h2 class="font-black text-xl border-b border-slate-700 pb-2">PAINEL OBRA</h2>
    <button onclick="document.getElementById('fCurva').click()" class="w-full bg-blue-600 hover:bg-blue-700 p-2 rounded text-sm font-bold">üìÇ IMPORTAR CURVA S</button>
    <button onclick="document.getElementById('fHH').click()" class="w-full bg-emerald-600 hover:bg-emerald-700 p-2 rounded text-sm font-bold">üë∑ IMPORTAR HH</button>
    <button onclick="abrirConfig()" class="w-full bg-slate-700 hover:bg-slate-600 p-2 rounded text-sm font-bold">‚öôÔ∏è CONFIGURA√á√ÉO</button>
    <input type="file" id="fCurva" class="hidden" accept=".xlsx">
    <input type="file" id="fHH" class="hidden" accept=".xlsx">
</div>

<div class="main-content">
    <div class="card mb-6">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <div class="w-40 h-16 flex items-center border-2 border-dashed rounded justify-center overflow-hidden">
                <img id="logoEmpresa" src="https://via.placeholder.com/150x50?text=LOGO+EMPRESA" class="max-h-full">
            </div>
            <div class="text-center">
                <h1 class="text-3xl font-black text-blue-900 uppercase">Painel de Bordo</h1>
                <p id="txtSinc" class="text-orange-600 font-bold animate-pulse text-xs">SINCRONIZANDO...</p>
                <p id="infoObra" class="text-slate-500 font-bold uppercase text-sm"></p>
            </div>
            <div class="w-40 h-16 flex items-center border-2 border-dashed rounded justify-center overflow-hidden">
                <img id="logoCliente" src="" class="max-h-full hidden">
                <span id="labelLogo" class="text-xs text-slate-400 font-bold">LOGO CLIENTE</span>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-900 p-4 rounded text-white text-center">
                <span class="text-[10px] uppercase opacity-70">Avan√ßo Real</span>
                <b id="valAvanco" class="block text-2xl text-green-400">0.00%</b>
            </div>
            <div class="bg-blue-900 p-4 rounded text-white text-center">
                <span class="text-[10px] uppercase opacity-70">Produtividade</span>
                <b id="valProd" class="block text-2xl text-yellow-400">0%</b>
            </div>
            <div class="bg-blue-900 p-4 rounded text-white text-center">
                <span class="text-[10px] uppercase opacity-70">HH Real</span>
                <b id="valHH" class="block text-2xl">0.00</b>
            </div>
            <div class="bg-blue-900 p-4 rounded text-white text-center">
                <span class="text-[10px] uppercase opacity-70">Semana Ref.</span>
                <select id="selSemana" class="block w-full bg-transparent font-bold text-center outline-none cursor-pointer"></select>
            </div>
        </div>

        <table class="tab-bor mb-6">
            <thead class="header-azul">
                <tr>
                    <th>INDICADORES</th><th>Anterior</th><th>SEG</th><th>TER</th><th>QUA</th><th>QUI</th><th>SEX</th><th>SAB</th><th>DOM</th><th>Semana</th><th>Acumulado</th>
                </tr>
            </thead>
            <tbody id="corpoTab"></tbody>
        </table>

        <div class="grid grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="border p-2 bg-slate-50"><label class="text-[10px] font-bold">AN√ÅLISE DE PLANEJAMENTO</label><textarea id="notPlan" class="w-full h-24 border rounded p-2 text-sm" oninput="salvarNotas()"></textarea></div>
                <div class="border p-2 bg-slate-50"><label class="text-[10px] font-bold">GEST√ÉO DE ENGENHARIA</label><textarea id="notEng" class="w-full h-24 border rounded p-2 text-sm" oninput="salvarNotas()"></textarea></div>
            </div>
            <div class="border p-4 h-[300px] bg-white"><canvas id="graficoCurva"></canvas></div>
        </div>
    </div>
</div>

<div id="modalCfg" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 shadow-2xl">
        <h3 class="font-bold border-b mb-4">Configura√ß√µes da Obra</h3>
        <div class="space-y-3 text-xs font-bold">
            <label>CLIENTE:</label><input type="text" id="cfgCli" class="w-full border p-1">
            <label>OBRA:</label><input type="text" id="cfgObra" class="w-full border p-1">
            <label>LINK LOGO CLIENTE (URL):</label><input type="text" id="cfgLogo" class="w-full border p-1" placeholder="https://...">
            <label>HH TOTAL CONTRATO:</label><input type="number" id="cfgHH" class="w-full border p-1">
        </div>
        <button onclick="salvarConfig()" class="w-full bg-blue-900 text-white p-2 mt-4 rounded font-bold">SALVAR NO FIREBASE</button>
        <button onclick="document.getElementById('modalCfg').classList.add('hidden')" class="w-full text-slate-400 text-xs mt-2">FECHAR</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAW35OKtqp0sp6vBgC3QsDyB31nfO6gQyo",
      authDomain: "painel-de-bordo-3f96a.firebaseapp.com",
      databaseURL: "https://painel-de-bordo-3f96a-default-rtdb.firebaseio.com",
      projectId: "painel-de-bordo-3f96a",
      storageBucket: "painel-de-bordo-3f96a.firebasestorage.app",
      messagingSenderId: "444721715892",
      appId: "1:444721715892:web:320c09972eac5632f3d5e1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dadosCurva = [], chart = null;

    // --- SINCRONIZA√á√ÉO ---
    db.ref('painel').on('value', snap => {
        const data = snap.val() || {};
        document.getElementById('txtSinc').classList.add('hidden');
        
        if(data.config) {
            document.getElementById('infoObra').innerText = `${data.config.cliente} | ${data.config.obra}`;
            if(data.config.logo) {
                document.getElementById('logoCliente').src = data.config.logo;
                document.getElementById('logoCliente').classList.remove('hidden');
                document.getElementById('labelLogo').classList.add('hidden');
            }
        }

        dadosCurva = data.curva || [];
        if(dadosCurva.length > 0) {
            popularSemanas();
            atualizarTudo();
        }
    });

    function popularSemanas() {
        const sems = [...new Set(dadosCurva.map(x => x.Semana))];
        const sel = document.getElementById('selSemana');
        const v = sel.value;
        sel.innerHTML = '';
        sems.forEach(s => sel.add(new Option(s, s)));
        sel.value = v || sems[sems.length-1];
    }

    document.getElementById('selSemana').onchange = atualizarTudo;

    function atualizarTudo() {
        const sSel = document.getElementById('selSemana').value;
        const nSel = parseInt(sSel.replace(/\D/g,''));
        
        // C√°lculos de Avan√ßo
        const realAcm = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) <= nSel).reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);
        document.getElementById('valAvanco').innerText = (realAcm * 100).toFixed(2) + "%";

        renderizarGrafico(nSel);
        renderizarTabela(sSel, nSel);
    }

    function renderizarTabela(sSel, nSel) {
        const dias = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
        const pAcmAnt = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSel).reduce((a,c)=>a+(c.Avanco_Previsto_Perc||0),0);
        const rAcmAnt = dadosCurva.filter(x => parseInt(x.Semana.replace(/\D/g,'')) < nSel).reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);

        let html = `<tr><td class="font-bold">Previsto (%)</td><td>${(pAcmAnt*100).toFixed(2)}%</td>`;
        let somaS = 0;
        dias.forEach(d => {
            const v = dadosCurva.find(x => x.Semana === sSel && x.Dia.includes(d))?.Avanco_Previsto_Perc || 0;
            somaS += v;
            html += `<td>${(v*100).toFixed(2)}%</td>`;
        });
        html += `<td>${(somaS*100).toFixed(2)}%</td><td class="bg-slate-100 font-bold">${((pAcmAnt+somaS)*100).toFixed(2)}%</td></tr>`;
        
        document.getElementById('corpoTab').innerHTML = html;
    }

    function renderizarGrafico(nSel) {
        const ctx = document.getElementById('graficoCurva').getContext('2d');
        const sems = [...new Set(dadosCurva.map(x => x.Semana))];
        let pAcm = 0, rAcm = 0, labels = [], dP = [], dR = [];

        sems.forEach(s => {
            const nS = parseInt(s.replace(/\D/g,''));
            labels.push(s);
            const d = dadosCurva.filter(x => x.Semana === s);
            pAcm += d.reduce((a,c)=>a+(c.Avanco_Previsto_Perc||0),0);
            dP.push((pAcm*100).toFixed(2));
            
            if(nS <= nSel) {
                rAcm += d.reduce((a,c)=>a+(c.Avanco_Realizado_Perc||0),0);
                dR.push((rAcm*100).toFixed(2));
            }
        });

        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Planejado', data: dP, borderColor: '#cbd5e1', borderDash: [5,5], pointRadius: 0 },
                    { label: 'Realizado', data: dR, borderColor: '#10b981', borderWidth: 3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
        });
    }

    // --- IMPORTA√á√ÉO ---
    function setupImport(id, path) {
        document.getElementById(id).onchange = e => {
            const reader = new FileReader();
            reader.onload = evt => {
                const wb = XLSX.read(evt.target.result, {type:'binary'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                db.ref(`painel/${path}`).set(json).then(() => alert("DADOS CARREGADOS!"));
            };
            reader.readAsBinaryString(e.target.files[0]);
        };
    }
    setupImport('fCurva', 'curva');
    setupImport('fHH', 'hh');

    function abrirConfig() { document.getElementById('modalCfg').classList.remove('hidden'); }
    function salvarConfig() {
        const c = {
            cliente: document.getElementById('cfgCli').value,
            obra: document.getElementById('cfgObra').value,
            logo: document.getElementById('cfgLogo').value,
            hh: document.getElementById('cfgHH').value
        };
        db.ref('painel/config').set(c).then(() => document.getElementById('modalCfg').classList.add('hidden'));
    }
</script>
</body>
</html>
