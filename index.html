<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Bordo v28</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; }
        .sidebar { width: 260px; height: 100vh; position: fixed; background: #0f172a; color: white; padding: 20px; }
        .conteudo { margin-left: 260px; padding: 20px; }
        .tabela-obra { width: 100%; border-collapse: collapse; font-size: 10px; background: white; }
        .tabela-obra th, .tabela-obra td { border: 1px solid #cbd5e1; padding: 5px; text-align: center; }
        .header-blue { background: #1e3a8a; color: white; font-weight: bold; }
        .col-destaque { background: #f8fafc; font-weight: bold; color: #1e3a8a; }
        .col-preta { background: #0f172a !important; color: white; font-weight: bold; }
        .card-mini { background: white; border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="sidebar flex flex-col gap-3">
    <h2 class="text-xl font-black mb-4 border-b border-slate-700 pb-2 text-blue-400 italic">PAINEL OBRA</h2>
    <button onclick="document.getElementById('fCurva').click()" class="bg-blue-600 p-3 rounded font-bold hover:bg-blue-500">üìÇ IMPORTAR CURVA S</button>
    <button onclick="abrirConfig()" class="bg-slate-700 p-3 rounded font-bold hover:bg-slate-600">‚öôÔ∏è CONFIGURA√á√ÉO</button>
    <input type="file" id="fCurva" class="hidden" accept=".xlsx">
    <input type="file" id="upLogo" class="hidden" accept="image/*" onchange="uploadLogo(this)">
</div>

<div class="conteudo">
    <div class="flex justify-between items-center mb-4 bg-white p-4 rounded shadow-sm">
        <div class="w-40 h-16 border flex items-center justify-center cursor-pointer" onclick="document.getElementById('upLogo').click()">
            <img id="imgLogo" src="" class="max-h-full hidden">
            <span id="txtLogo" class="text-[10px] text-slate-400 font-bold">LOGO CLIENTE</span>
        </div>
        <div class="text-center">
            <h1 class="text-3xl font-black text-blue-900 uppercase italic">Painel de Bordo</h1>
            <p id="txtClienteObra" class="text-xs font-bold text-slate-500 italic">CLIENTE | OBRA</p>
        </div>
        <div class="w-40"></div>
    </div>

    <div class="grid grid-cols-6 gap-1 mb-4">
        <div class="card-mini"><span class="block text-[9px] uppercase">In√≠cio</span><b id="dIni">-</b></div>
        <div class="card-mini"><span class="block text-[9px] uppercase">T√©rmino</span><b id="dFim">-</b></div>
        <div class="card-mini text-green-600"><span class="block text-[9px] uppercase">Prazo Total</span><b id="dPrazo">-</b></div>
        <div class="card-mini text-orange-600"><span class="block text-[9px] uppercase">Transcorridos</span><b id="dTrans">-</b></div>
        <div class="card-mini text-red-600"><span class="block text-[9px] uppercase">Saldo Dias</span><b id="dSaldo">-</b></div>
        <div class="card-mini"><span class="block text-[9px] uppercase">HH Contrato</span><b id="dHHCon">-</b></div>
    </div>

    <table class="tabela-obra">
        <thead>
            <tr class="header-blue">
                <th rowspan="2" class="w-40">INDICADORES DE DESEMPENHO</th>
                <th rowspan="2">ANTERIOR</th>
                <th colspan="7" id="labelSemanaHeader">DIAS DA SEMANA</th>
                <th rowspan="2" class="col-destaque">SEMANA</th>
                <th rowspan="2" class="col-preta">ACUMULADO</th>
            </tr>
            <tr class="header-blue">
                <th>SEG</th><th>TER</th><th>QUA</th><th>QUI</th><th>SEX</th><th>SAB</th><th>DOM</th>
            </tr>
        </thead>
        <tbody id="corpoTabela"></tbody>
    </table>

    <div class="grid grid-cols-3 gap-4 mt-6">
        <div class="col-span-1 space-y-4">
            <div class="bg-white p-4 rounded border"><h4 class="text-[10px] font-bold border-b mb-2">AN√ÅLISE DE PLANEJAMENTO</h4><textarea class="w-full h-24 text-xs outline-none resize-none"></textarea></div>
            <div class="bg-white p-4 rounded border"><h4 class="text-[10px] font-bold border-b mb-2">GEST√ÉO DE ENGENHARIA</h4><textarea class="w-full h-24 text-xs outline-none resize-none"></textarea></div>
        </div>
        <div class="col-span-2 bg-white p-4 rounded border" style="height: 350px;">
            <canvas id="graficoCurva"></canvas>
        </div>
    </div>
</div>

<div id="modalCfg" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[200]">
    <div class="bg-white p-6 rounded-lg w-96 shadow-2xl">
        <h2 class="font-black mb-4 text-blue-900">CONFIGURA√á√ÉO DO PROJETO</h2>
        <div class="space-y-2">
            <input type="text" id="cfgCli" placeholder="CLIENTE" class="w-full border p-2 text-sm">
            <input type="text" id="cfgObra" placeholder="OBRA" class="w-full border p-2 text-sm">
            <input type="date" id="cfgIni" class="w-full border p-2 text-sm">
            <input type="date" id="cfgFim" class="w-full border p-2 text-sm">
            <input type="number" id="cfgHH" placeholder="HH TOTAL CONTRATO" class="w-full border p-2 text-sm">
        </div>
        <div class="flex gap-2 mt-4">
            <button onclick="salvarConfig()" class="flex-1 bg-blue-900 text-white p-2 font-bold rounded">SALVAR</button>
            <button onclick="document.getElementById('modalCfg').classList.add('hidden')" class="flex-1 bg-slate-200 p-2 rounded">CANCELAR</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAW35OKtqp0sp6vBgC3QsDyB31nfO6gQyo",
      authDomain: "painel-de-bordo-3f96a.firebaseapp.com",
      databaseURL: "https://painel-de-bordo-3f96a-default-rtdb.firebaseio.com",
      storageBucket: "painel-de-bordo-3f96a.firebasestorage.app",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let dados = [], chart = null;

    // Sincroniza√ß√£o em Tempo Real
    db.ref('painel').on('value', snap => {
        const d = snap.val() || {};
        if(d.config) {
            document.getElementById('txtClienteObra').innerText = `${d.config.cliente} | ${d.config.obra}`.toUpperCase();
            document.getElementById('dIni').innerText = d.config.inicio || '-';
            document.getElementById('dFim').innerText = d.config.fim || '-';
            document.getElementById('dHHCon').innerText = Number(d.config.hh).toLocaleString();
            if(d.config.logoURL) {
                document.getElementById('imgLogo').src = d.config.logoURL;
                document.getElementById('imgLogo').classList.remove('hidden');
                document.getElementById('txtLogo').classList.add('hidden');
            }
        }
        dados = d.curva || [];
        if(dados.length > 0) renderizarTudo();
    });

    function abrirConfig() { document.getElementById('modalCfg').classList.remove('hidden'); }

    function salvarConfig() {
        const obj = {
            cliente: document.getElementById('cfgCli').value,
            obra: document.getElementById('cfgObra').value,
            inicio: document.getElementById('cfgIni').value,
            fim: document.getElementById('cfgFim').value,
            hh: document.getElementById('cfgHH').value
        };
        db.ref('painel/config').update(obj).then(() => {
            document.getElementById('modalCfg').classList.add('hidden');
            alert("Configura√ß√£o Salva!");
        });
    }

    async function uploadLogo(input) {
        const file = input.files[0];
        const ref = storage.ref('logos/cliente_logo.jpg');
        await ref.put(file);
        const url = await ref.getDownloadURL();
        db.ref('painel/config').update({ logoURL: url });
    }

    function renderizarTudo() {
        // L√≥gica simplificada para S08 como exemplo (Pode ser din√¢mica via Select)
        const semRef = "S08"; 
        const nRef = 8;
        const dias = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
        
        const filtrar = (lista, n) => lista.filter(x => parseInt(x.Semana.replace(/\D/g,'')) <= n);
        const fmt = (v, p) => p ? (v*100).toFixed(2)+'%' : Math.round(v).toLocaleString();

        const gerarLinha = (label, key, isP) => {
            const filtAcm = filtrar(dados, nRef);
            const filtSem = dados.filter(x => x.Semana === semRef);
            const filtAnt = filtrar(dados, nRef - 1);

            let ant = filtAnt.reduce((a,c) => a + (c[key]||0), 0);
            let sem = filtSem.reduce((a,c) => a + (c[key]||0), 0);
            let acm = filtAcm.reduce((a,c) => a + (c[key]||0), 0);

            let h = `<tr><td class="text-left font-bold bg-slate-50">${label}</td><td>${fmt(ant,isP)}</td>`;
            dias.forEach(d => {
                let v = filtSem.find(x => x.Dia.includes(d))?.[key] || 0;
                h += `<td>${v > 0 ? fmt(v,isP) : '-'}</td>`;
            });
            h += `<td class="col-destaque">${fmt(sem,isP)}</td><td class="col-preta">${fmt(acm,isP)}</td></tr>`;
            return h;
        };

        let html = gerarLinha('PREVISTO (%)', 'Avanco_Previsto_Perc', true);
        html += gerarLinha('REALIZADO (%)', 'Avanco_Realizado_Perc', true);
        html += gerarLinha('HH AGREGADO', 'HH_Agregado', false);
        html += gerarLinha('HH REAL', 'HH_Real', false);

        document.getElementById('corpoTabela').innerHTML = html;
    }

    // Importador
    document.getElementById('fCurva').onchange = e => {
        const reader = new FileReader();
        reader.onload = evt => {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            db.ref('painel/curva').set(json).then(() => alert("Dados Importados!"));
        };
        reader.readAsBinaryString(e.target.files[0]);
    };
</script>
</body>
</html>